<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<!-- Шрифты и стили -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  :root {
    /* Светлая тема (по умолчанию) */
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --bg-card: #ffffff;
    --bg-header: #4f46e5;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-inverse: #ffffff;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08);
    --accent-primary: #4f46e5;
    --accent-secondary: #8b5cf6;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .dark-theme {
    /* Темная тема */
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --bg-header: #3730a3;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-inverse: #0f172a;
    --border-color: #334155;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.25);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3);
    --accent-primary: #6366f1;
    --accent-secondary: #8b5cf6;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    transition: var(--transition);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* Хедер */
  .header {
    background: linear-gradient(135deg, var(--bg-header) 0%, var(--accent-secondary) 100%);
    padding: 2rem 1.5rem;
    position: relative;
    overflow: hidden;
    min-height: 80px;
  }

  .header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  .header-content {
    position: relative;
    z-index: 2;
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
    color: var(--text-inverse);
  }

  .header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    letter-spacing: -0.5px;
  }

  .header-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    max-width: 700px;
    margin: 0 auto;
  }

  /* Контролы темы */
  .theme-toggle {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 1.5rem;
    transition: var(--transition);
    z-index: 10;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: rotate(15deg);
  }

  /* Основной контент */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  /* Карточка с действиями */
  .action-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    margin-bottom: 2.5rem;
    border: 1px solid var(--border-color);
    transition: var(--transition);
    animation: fadeInUp 0.6s ease-out;
  }

  .action-card:hover {
    box-shadow: var(--shadow-lg), 0 20px 25px -5px rgba(0, 0, 0, 0.05);
  }

  .action-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    justify-content: center; /* Центрируем по горизонтали */
  }

  .action-icon {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
    font-size: 1.2rem;
  }

  .action-header h2 {
    font-size: 1.75rem;
    font-weight: 600;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    justify-content: center; /* Центрирование по горизонтали */
  }

  /* Кнопки */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.875rem 1.75rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: none;
    transition: var(--transition);
    min-width: 180px;
    position: relative;
    overflow: hidden;
  }

  .btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }

  .btn:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }

  .btn i {
    margin-right: 0.75rem;
    font-size: 1.1rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
  }

  .btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover {
    background: var(--border-color);
    transform: translateY(-2px);
  }

  /* Статусы */
  .status-container {
    margin-top: 1.5rem;
  }

  .status {
    padding: 1.25rem;
    border-radius: var(--radius-md);
    font-size: 1rem;
    transition: var(--transition);
    animation: slideIn 0.4s ease-out;
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .status i {
    margin-right: 0.75rem;
    font-size: 1.2rem;
  }

  .status.success {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-left: 4px solid var(--success);
  }

  .status.error {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--error);
    border-left: 4px solid var(--error);
  }

  /* Загрузка */
  .loading {
    display: none;
    margin-top: 1.5rem;
    text-align: center;
    padding: 1.5rem;
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    animation: pulse 2s infinite;
  }

  .loading-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  /* KPI Карточки */
  .kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }

  .kpi-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    text-align: center;
  }

  .kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }

  .kpi-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: white;
  }

  .kpi-icon.suppliers {
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
  }

  .kpi-icon.rows {
    background: linear-gradient(135deg, #10b981, #34d399);
  }

  .kpi-icon.avg {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
  }

  .kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0.5rem 0;
    color: var(--accent-primary);
  }

  .kpi-label {
    font-size: 1rem;
    color: var(--text-secondary);
  }

  /* Секции */
  .section {
    margin-top: 3rem;
    animation: fadeIn 0.8s ease-out;
  }

  .section-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border-color);
  }

  .section-header h2 {
    font-size: 1.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
  }

  .section-header i {
    margin-right: 0.75rem;
    color: var(--accent-primary);
  }

  /* График */
  .chart-container {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    height: 500px;
    transition: var(--transition);
  }

  .chart-container:hover {
    box-shadow: var(--shadow-lg);
  }

  #data-chart {
    max-width: 100%;
    max-height: 100%;
  }

  /* Таблица и фильтры */
  .table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .search-box {
    position: relative;
    flex-grow: 1;
    max-width: 400px;
  }

  .search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
  }

  .search-box input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 1rem;
    transition: var(--transition);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .table-info {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .table-container {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    overflow-x: auto;
    transition: var(--transition);
  }

  .table-container:hover {
    box-shadow: var(--shadow-lg);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }

  thead {
    background: var(--bg-secondary);
  }

  th {
    padding: 1.25rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
    font-size: 1rem;
  }

  td {
    padding: 1.25rem 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
  }

  tbody tr {
    transition: var(--transition);
  }

  tbody tr:hover {
    background: var(--bg-secondary);
  }

  /* Пагинация */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
  }

  .pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-primary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    min-width: 40px;
  }

  .pagination button:hover:not(:disabled) {
    background: var(--bg-secondary);
  }

  .pagination button.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Кнопка скачивания */
  .download-section {
    margin-top: 2rem;
    text-align: center;
  }

  .download-dropdown {
    position: relative;
    display: inline-block;
  }

  .download-btn {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    padding: 0.875rem 2rem;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: var(--transition);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
  }

  .download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
  }

  .download-btn i {
    font-size: 1.2rem;
  }

  .download-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    z-index: 100;
    margin-top: 0.5rem;
    overflow: hidden;
  }

  .download-options.show {
    display: block;
  }

  .download-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    color: var(--text-primary);
    text-decoration: none;
    transition: var(--transition);
    border-bottom: 1px solid var(--border-color);
  }

  .download-option:last-child {
    border-bottom: none;
  }

  .download-option:hover {
    background: var(--bg-secondary);
  }

  .download-option i {
    color: var(--accent-primary);
    font-size: 1.1rem;
  }

  /* Футер */
  .footer {
    text-align: center;
    padding: 2rem 1.5rem;
    margin-top: 3rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
    border-top: 1px solid var(--border-color);
  }

  /* Анимации */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 1;
    }
    20% {
      transform: scale(25, 25);
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: scale(40, 40);
    }
  }

  @keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    .header h1 {
      font-size: 2rem;
    }
    
    .header-subtitle {
      font-size: 1rem;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
    
    .chart-container {
      height: 400px;
      padding: 1.5rem;
    }
    
    .container {
      padding: 1.5rem 1rem;
    }
    
    .action-card {
      padding: 1.5rem;
    }
    
    .section-header h2 {
      font-size: 1.5rem;
    }
    
    .download-options {
      left: 0;
      transform: none;
    }
    
    .table-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-box {
      max-width: 100%;
    }
  }

  @media (max-width: 480px) {
    .chart-container {
      height: 300px;
      padding: 1rem;
    }
    
    .header {
      padding: 1.5rem 1rem;
    }
    
    .theme-toggle {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
    }
    
    .download-btn {
      width: 100%;
      justify-content: center;
    }
    
    .kpi-container {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <!-- Хедер -->
  <header class="header">
    <button class="theme-toggle" id="theme-toggle" aria-label="Переключить тему">
      <i class="fas fa-moon"></i>
    </button>
    <div class="header-content">
    </div>
  </header>
  
  <!-- Основной контент -->
  <main class="container">
    <!-- Карточка с действиями -->
    <section class="action-card">
      <div class="action-header">
        <div class="action-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <h2>Данные по количеству отключенных товаров и поставщиков</h2>
      </div>
      
      <div class="action-buttons">
        <button id="load-data" class="btn btn-primary">
          <i class="fas fa-cloud-download-alt"></i>Загрузить данные
        </button>
        <button id="refresh-data" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i>Обновить данные
        </button>
      </div>
      
      <div class="status-container">
        <div class="status" id="status"></div>
        <div class="status error" id="error" style="display:none;"></div>
      </div>
      
      <div class="loading" id="loading">
        <div class="loading-content">
          <div class="spinner"></div>
          <span>Обработка данных...</span>
        </div>
      </div>
    </section>

    <!-- KPI Карточки -->
    <div class="kpi-container" id="kpi-container" style="display: none;">
      <div class="kpi-card">
        <div class="kpi-icon suppliers">
          <i class="fas fa-truck"></i>
        </div>
        <div class="kpi-value" id="kpi-suppliers">0</div>
        <div class="kpi-label">Всего поставщиков</div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-icon rows">
          <i class="fas fa-list-alt"></i>
        </div>
        <div class="kpi-value" id="kpi-total-rows">0</div>
        <div class="kpi-label">Всего строк с кодом 1С</div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-icon avg">
          <i class="fas fa-calculator"></i>
        </div>
        <div class="kpi-value" id="kpi-avg-rows">0</div>
        <div class="kpi-label">Среднее на поставщика</div>
      </div>
    </div>

    <!-- График -->
    <section class="section">
      <div class="section-header">
        <h2><i class="fas fa-chart-bar"></i>Визуализация данных</h2>
      </div>
      <div class="chart-container">
        <canvas id="data-chart"></canvas>
      </div>
    </section>

    <!-- Кнопка скачивания -->
    <section class="download-section">
      <div class="download-dropdown">
        <button class="download-btn" id="download-btn">
          <i class="fas fa-download"></i>Скачать данные
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="download-options" id="download-options">
          <a href="#" class="download-option" id="download-png">
            <i class="fas fa-file-image"></i>
            <span>Скачать график (PNG)</span>
          </a>
          <a href="#" class="download-option" id="download-excel">
            <i class="fas fa-file-excel"></i>
            <span>Скачать данные (CSV)</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Таблица -->
    <section class="section">
      <div class="section-header">
        <h2><i class="fas fa-table"></i>Результаты анализа</h2>
      </div>
      
      <div class="table-controls">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="search-input" placeholder="Поиск поставщика...">
        </div>
        <div class="table-info">
          Показано: <span id="shown-count">0</span> из <span id="total-count">0</span>
        </div>
      </div>
      
      <div class="table-container">
        <table id="data-table">
          <thead>
            <tr>
              <th>Поставщик</th>
              <th>Количество строк с Кодом 1С</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="2" style="text-align: center; padding: 3rem;">
                <i class="fas fa-database" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 1rem; display: block;"></i>
                <p>Данные не загружены. Нажмите "Загрузить данные" для начала анализа.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="pagination" id="pagination" style="display: none;">
        <button id="prev-page" disabled><i class="fas fa-chevron-left"></i></button>
        <div id="page-numbers"></div>
        <button id="next-page" disabled><i class="fas fa-chevron-right"></i></button>
      </div>
    </section>
  </main>

  <!-- Футер -->
  <footer class="footer">
    <p>Обновлено: <span id="update-time">-</span></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Элементы DOM
      const themeToggle = document.getElementById('theme-toggle');
      const loadBtn = document.getElementById('load-data');
      const refreshBtn = document.getElementById('refresh-data');
      const loadingEl = document.getElementById('loading');
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');
      const tableBody = document.getElementById('table-body');
      const updateTimeEl = document.getElementById('update-time');
      const downloadBtn = document.getElementById('download-btn');
      const downloadOptions = document.getElementById('download-options');
      const downloadPng = document.getElementById('download-png');
      const downloadExcel = document.getElementById('download-excel');
      const kpiContainer = document.getElementById('kpi-container');
      const searchInput = document.getElementById('search-input');
      const shownCountEl = document.getElementById('shown-count');
      const totalCountEl = document.getElementById('total-count');
      const paginationEl = document.getElementById('pagination');
      const prevPageBtn = document.getElementById('prev-page');
      const nextPageBtn = document.getElementById('next-page');
      const pageNumbersEl = document.getElementById('page-numbers');
      
      let dataChart = null;
      let currentData = [];
      let filteredData = [];
      
      // Настройки пагинации
      const rowsPerPage = 10;
      let currentPage = 1;
      let totalPages = 1;
      
      // URL таблицы
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1h0aN6sMWmnGwWYGYLWLlSZxVHRU2YI4Qh0BEX_SVHQE/edit?gid=0';

      // Переключение темы
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-theme');
        const icon = themeToggle.querySelector('i');
        if (document.body.classList.contains('dark-theme')) {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }
        
        // Обновляем график при смене темы
        if (dataChart) {
          dataChart.destroy();
          if (currentData.length > 0) {
            createChart(currentData);
          }
        }
      });

      // Управление выпадающим меню скачивания
      downloadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        downloadOptions.classList.toggle('show');
      });

      document.addEventListener('click', (e) => {
        if (!downloadBtn.contains(e.target) && !downloadOptions.contains(e.target)) {
          downloadOptions.classList.remove('show');
        }
      });

      // Поиск
      searchInput.addEventListener('input', () => {
        currentPage = 1;
        filterData();
        updateTable();
        updatePagination();
      });

      // Пагинация
      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          updateTable();
          updatePagination();
        }
      });

      nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          updateTable();
          updatePagination();
        }
      });

      // Функции для скачивания
      downloadPng.addEventListener('click', (e) => {
        e.preventDefault();
        downloadOptions.classList.remove('show');
        downloadChartAsPNG();
      });

      downloadExcel.addEventListener('click', (e) => {
        e.preventDefault();
        downloadOptions.classList.remove('show');
        downloadDataAsExcel();
      });

      function downloadChartAsPNG() {
        if (!dataChart) {
          showStatus('График не загружен. Сначала загрузите данные.', false);
          return;
        }

        try {
          const canvas = document.getElementById('data-chart');
          const link = document.createElement('a');
          link.download = `график_поставщиков_${new Date().toISOString().split('T')[0]}.png`;
          link.href = canvas.toDataURL('image/png');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showStatus('График успешно скачан в формате PNG!', true);
        } catch (err) {
          console.error('Ошибка скачивания PNG:', err);
          showError('Не удалось скачать график в формате PNG');
        }
      }

      function downloadDataAsExcel() {
        const data = currentData;
        if (!data || data.length === 0) {
          showStatus('Нет данных для скачивания. Сначала загрузите данные.', false);
          return;
        }

        try {
          let csvContent = "Поставщик,Количество строк с Кодом 1С\n";
          data.forEach(item => {
            csvContent += `"${item.supplier}",${item.count}\n`;
          });

          const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          
          link.setAttribute('href', url);
          link.setAttribute('download', `данные_поставщиков_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showStatus('Данные успешно скачаны в формате CSV!', true);
        } catch (err) {
          console.error('Ошибка скачивания CSV:', err);
          showError('Не удалось скачать данные в формате CSV');
        }
      }

      // Функции для работы с UI
      function showLoading(show) {
        loadingEl.style.display = show ? 'block' : 'none';
        if (show) {
          loadBtn.disabled = true;
          refreshBtn.disabled = true;
        }
      }

      function showError(msg) {
        errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i>${msg}`;
        errorEl.style.display = 'flex';
        statusEl.innerHTML = `<i class="fas fa-times-circle"></i>Ошибка: ${msg}`;
        statusEl.className = 'status error';
      }

      function showStatus(msg, success = true) {
        const icon = success ? 'fa-check-circle' : 'fa-exclamation-circle';
        statusEl.innerHTML = `<i class="fas ${icon}"></i>${msg}`;
        statusEl.className = success ? 'status success' : 'status error';
        errorEl.style.display = 'none';
        
        // Обновляем время
        const now = new Date();
        updateTimeEl.textContent = now.toLocaleTimeString('ru-RU', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
      }

      function updateKPI(data) {
        if (!data || data.length === 0) {
          kpiContainer.style.display = 'none';
          return;
        }
        
        kpiContainer.style.display = 'grid';
        
        const totalSuppliers = data.length;
        const totalRows = data.reduce((sum, item) => sum + item.count, 0);
        const avgRows = totalSuppliers > 0 ? (totalRows / totalSuppliers).toFixed(1) : 0;
        
        // Анимируем счетчики
        animateCounter('kpi-suppliers', totalSuppliers);
        animateCounter('kpi-total-rows', totalRows);
        animateCounter('kpi-avg-rows', avgRows);
      }

      function animateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const currentValue = parseInt(element.textContent) || 0;
        const duration = 1000; // 1 секунда
        const stepTime = 20; // каждые 20мс
        const steps = duration / stepTime;
        const increment = (targetValue - currentValue) / steps;
        let currentStep = 0;
        
        const timer = setInterval(() => {
          currentStep++;
          const newValue = Math.round(currentValue + (increment * currentStep));
          element.textContent = newValue;
          
          if (currentStep >= steps) {
            element.textContent = targetValue;
            clearInterval(timer);
          }
        }, stepTime);
      }

      function filterData() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (!searchTerm) {
          filteredData = [...currentData];
        } else {
          filteredData = currentData.filter(item => 
            item.supplier.toLowerCase().includes(searchTerm)
          );
        }
        
        totalPages = Math.ceil(filteredData.length / rowsPerPage);
        shownCountEl.textContent = filteredData.length;
      }

      function updateTable() {
        if (!filteredData || filteredData.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="2" style="text-align: center; padding: 2rem;">
                <i class="fas fa-search" style="font-size: 1.5rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;"></i>
                <p>${currentData.length === 0 ? 'Данные не загружены' : 'По вашему запросу ничего не найдено'}</p>
              </td>
            </tr>
          `;
          return;
        }
        
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);
        
        tableBody.innerHTML = '';
        pageData.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${item.supplier}</strong></td>
            <td><span class="count-badge">${item.count}</span></td>
          `;
          tableBody.appendChild(row);
        });
        
        // Добавляем стили для бейджей
        if (!document.querySelector('#badge-styles')) {
          const style = document.createElement('style');
          style.id = 'badge-styles';
          style.textContent = `
            .count-badge {
              display: inline-block;
              background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
              color: white;
              padding: 0.25rem 0.75rem;
              border-radius: 20px;
              font-weight: 600;
              font-size: 0.9rem;
              animation: countUp 0.5s ease-out;
            }
          `;
          document.head.appendChild(style);
        }
      }

      function updatePagination() {
        if (filteredData.length <= rowsPerPage) {
          paginationEl.style.display = 'none';
          return;
        }
        
        paginationEl.style.display = 'flex';
        
        // Обновляем кнопки "Назад"/"Вперед"
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        
        // Обновляем номера страниц
        pageNumbersEl.innerHTML = '';
        
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        
        if (currentPage <= 3) {
          endPage = Math.min(5, totalPages);
        }
        
        if (currentPage >= totalPages - 2) {
          startPage = Math.max(1, totalPages - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = i === currentPage ? 'active' : '';
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            updateTable();
            updatePagination();
          });
          pageNumbersEl.appendChild(pageBtn);
        }
      }

      function convertToCsvUrl(url) {
        let baseUrl = url.split('/edit')[0];
        let gidMatch = url.match(/gid=(\d+)/);
        let gid = gidMatch ? gidMatch[1] : '0';
        return `${baseUrl}/export?format=csv&gid=${gid}`;
      }

      function parseCSV(text) {
        const rows = [];
        const lines = text.split('\n');
        for (const line of lines) {
          if (line.trim() === '') continue;
          const values = [];
          let current = '';
          let insideQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
              insideQuotes = !insideQuotes;
            } else if (ch === ',' && !insideQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += ch;
            }
          }
          values.push(current.trim());
          rows.push(values);
        }
        return rows;
      }

      function aggregateData(rows) {
        const result = [];
        const headers = rows[0];
        const codeIdx = headers.findIndex(h => h && (h.toLowerCase().includes('код') || h.toLowerCase().includes('1с')));
        const supplierIdx = headers.findIndex(h => h && h.toLowerCase().includes('поставщик'));

        const codeCol = codeIdx >= 0 ? codeIdx : 0;
        const supplierCol = supplierIdx >= 0 ? supplierIdx : 2;

        let currentSupplier = null;
        let currentCount = 0;

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.length === 0 || row.every(c => c.trim() === '')) continue;
          const supplier = (row[supplierCol] || '').trim() || 'Не указан';
          const hasCode = row[codeCol] !== undefined && row[codeCol].toString().trim() !== '';

          if (currentSupplier !== null && supplier !== currentSupplier) {
            result.push({ supplier: currentSupplier, count: currentCount });
            currentCount = 0;
          }
          currentSupplier = supplier;
          if (hasCode) currentCount++;
        }
        if (currentSupplier !== null && currentCount > 0) {
          result.push({ supplier: currentSupplier, count: currentCount });
        }
        
        // Сортируем по количеству (по убыванию)
        return result.sort((a, b) => b.count - a.count);
      }

      function createChart(data) {
        const ctx = document.getElementById('data-chart').getContext('2d');
        if (dataChart) dataChart.destroy();
        
        const labels = data.map(d => d.supplier);
        const values = data.map(d => d.count);
        
        // Генерация цветов с учетом темы
        const isDark = document.body.classList.contains('dark-theme');
        const colors = generateColors(labels.length, isDark);

        dataChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Код 1С по поставщикам',
              data: values,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.8', '1')),
              borderWidth: 1,
              borderRadius: 6,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: false 
              },
              tooltip: {
                backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                titleColor: isDark ? '#f1f5f9' : '#1e293b',
                bodyColor: isDark ? '#94a3b8' : '#64748b',
                borderColor: isDark ? '#475569' : '#e2e8f0',
                borderWidth: 1,
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y;
                    const total = values.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return [`${label}: ${value}`, `Доля: ${percentage}%`];
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { 
                  display: true, 
                  text: 'Количество строк',
                  color: isDark ? '#94a3b8' : '#64748b'
                },
                grid: {
                  color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(203, 213, 225, 0.5)'
                },
                ticks: {
                  color: isDark ? '#94a3b8' : '#64748b'
                }
              },
              x: {
                title: { 
                  display: true, 
                  text: 'Поставщик',
                  color: isDark ? '#94a3b8' : '#64748b'
                },
                grid: {
                  display: false
                },
                ticks: {
                  color: isDark ? '#94a3b8' : '#64748b',
                  maxRotation: 45,
                  minRotation: 0
                }
              }
            }
          }
        });
      }

      function generateColors(count, isDark = false) {
        const colors = [];
        const baseHue = 260; // Фиолетовый оттенок
        
        for (let i = 0; i < count; i++) {
          const hue = (baseHue + (i * 360) / count) % 360;
          const saturation = 70;
          const lightness = isDark ? 50 : 60;
          colors.push(`hsla(${hue}, ${saturation}%, ${lightness}%, 0.8)`);
        }
        return colors;
      }

      async function loadData() {
        try {
          showLoading(true);
          showStatus('Загрузка данных...', true);
          
          const url = convertToCsvUrl(SHEET_URL);
          const response = await fetch(`${url}&t=${Date.now()}`);
          
          if (!response.ok) throw new Error(`Ошибка загрузки: ${response.status}`);
          
          const csvText = await response.text();
          const rows = parseCSV(csvText);
          
          if (rows.length < 2) throw new Error('Недостаточно данных');
          
          const data = aggregateData(rows);
          currentData = data;
          totalCountEl.textContent = data.length;
          
          filterData();
          updateTable();
          updatePagination();
          updateKPI(data);
          createChart(data);
          
          showStatus(`Обработано ${rows.length - 1} строк, ${data.length} поставщиков.`, true);
        } catch (err) {
          console.error('Ошибка загрузки данных:', err);
          showError(err.message);
        } finally {
          showLoading(false);
          loadBtn.disabled = false;
          refreshBtn.disabled = false;
        }
      }

      // Назначаем обработчики событий
      loadBtn.addEventListener('click', loadData);
      refreshBtn.addEventListener('click', loadData);

      // Автоматическая загрузка при запуске
      setTimeout(() => {
        loadData();
      }, 500);
    });
  </script>
</body>
</html>
