<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<!-- Font Awesome для иконок -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Стиль -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

/* Переменные */
:root {
  --font-family: 'Inter', sans-serif;
  --border-radius: 16px;
  --shadow: rgba(0, 0, 0, 0.2);
  --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
  --accent-gradient: linear-gradient(135deg, #89f7fe, #66a6ff);
  --background-gradient: linear-gradient(135deg, #f0f2f5, #d9e2ef);
  --text-color: #222;
  --bg-color: #fff;
  --border-color: #ddd;
  --hover-bg-color: #f9f9f9;
  --label-color: #222;
  --chart-bg-color: #fafafa;
  --button-bg: linear-gradient(135deg, #667eea, #764ba2);
  --button-hover-bg: linear-gradient(135deg, #5a9, #4a8);
  --result-bg: linear-gradient(135deg, #e0f7fa, #b2ebf2);
  --chart-text-color: #222;
  --font-size-base: 16px;
  --changelog-header-color: #2c3e50;
  --changelog-date-color: #7f8c8d;
  --changelog-type-bg: #3498db;
  --changelog-entry-bg: #f9f9f9;
  --changelog-entry-text: #333;
  --section-padding: 24px;
  --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  --transition: all 0.3s ease;
}

/* Тёмная тема */
body.dark {
  --text-color: #eee;
  --bg-color: #1e1e1e;
  --border-color: #444;
  --hover-bg-color: #2a2a2a;
  --label-color: #ddd;
  --chart-bg-color: #2a2a2a;
  --button-bg: linear-gradient(135deg, #444, #222);
  --result-bg: linear-gradient(135deg, #333, #222);
  --chart-text-color: #eee;
  --changelog-version-color: #2c3e50;
  --changelog-date-color: #7f8c8d;
  --changelog-type-bg: #3498db;
  --changelog-entry-bg: #333;
  --changelog-entry-color: #eee;
  --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  --section-padding: 24px;
}
/* Общие стили */
body {
  margin: 0;
  font-family: var(--font-family);
  background: var(--background-gradient);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  color: var(--text-color);
  transition: var(--transition);
  line-height: 1.6;
}

/* Фиксированный футер */
#footer {
  position: fixed;
  bottom: 10px;
  width: 100%;
  text-align: center;
  font-family: var(--font-family);
  font-size: 14px;
  color: var(--text-color);
  padding: 12px 20px;
  border-radius: 16px 16px 0 0;
  backdrop-filter: blur(4px);
  transition: var(--transition);
  z-index: 1;
}

/* Кнопка смены темы */
.theme-switch {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--button-bg);
  border: none;
  padding: 14px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.4em;
  font-weight: 600;
  color: #fff;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  width: 45px;
  height: 45px;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
body.dark .theme-switch {
  background: linear-gradient(135deg, #444, #222);
}
.theme-switch:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px var(--shadow);
}

/* Основной контейнер, чтобы занимал всё пространство между верхом и низом */
body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  margin: 0;
}

.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0 20px;
  max-width: 1400px;
  margin: 0 auto;
  gap: 20px;
  width: 100%;
}

/* Верхняя панель */
.top-panel {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  margin-top: 80px;
}

/* Загрузка файла + кнопка */
.file-zone {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.file-label {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: var(--button-bg);
  color: #fff;
  padding: 16px 28px;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 1.3em;
  font-weight: 600;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  width: 100%;
  justify-content: center;
  text-align: center;
}
.file-label:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px var(--shadow);
  background: var(--button-bg);
}
#csvFileInput {
  display: none;
}
#exportSOTBtn {
 margin-top: 12px;
  padding: 16px 28px;
  font-size: 1.3em;
  border: none;
  border-radius: var(--border-radius);
  background: var(--button-bg);
  color: #fff;
  cursor: pointer;
  box-shadow: var(--card-shadow);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
  width: 100%;
  justify-content: center;
}
#exportSOTBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}
/* Стиль для кнопки "Назад" */
  .back-btn {
  display: none;
  align-items: center;
  gap: 10px;
  margin: 20px;
  margin-top: 70px;
  padding: 14px 24px;
  font-size: 20px;
  font-weight: 600;
  color: #fff;
  background:var(--button-bg);
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  text-decoration: none;
  }
  .back-btn:hover {
  background-color: #e64a19;
  transform: translateY(-2px);
}
/* Настройки */
.settings {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  flex: 1;
}
.setting-box {
  background: var(--hover-bg-color);
  padding: 20px;
  border-radius: calc(var(--border-radius));
  box-shadow: 0 4px 14px var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 220px;
  transition: all 0.2s ease;
}
.setting-box:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--shadow);
}
.setting-box label {
  font-weight: 600;
  margin-bottom: 12px;
  font-size: 1.1em;
  color: var(--label-color);
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.setting-box select {
  padding: 14px 20px;
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  background: var(--bg-color);
  font-size: 1em;
  width: 100%;
  color: var(--text-color);
  cursor: pointer;
  transition: var(--transition);
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9' /%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}
.setting-box select:hover {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

/* График и результаты */
.chart-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-bottom: 40px;
}
#chartTitle {
  margin-bottom: 20px;
  font-size: 1.8em;
  font-weight: 700;
  text-align: center;
  color: var(--label-color);
  padding: 16px;
  background: var(--bg-color);
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
}
/* Контейнер с графиком */
#chartContainer {
  flex: 1;
  min-height: 400px;
  background: var(--chart-bg-color);
  padding: 20px;
  border-radius: var(--border-radius);
  box-shadow: inset 0 8px 16px rgba(0, 0, 0, 0.05);
  display: flex;
}
#chartContainer canvas {
  width: 100%;
  height: 100%;
}
.buttons {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  justify-content: center;
  flex-wrap: wrap;
}
.btn {
  background: var(--button-bg);
  color: #fff;
  padding: 14px 28px;
  font-size: 1.3em;
  border: none;
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
  font-weight: 600;
}
.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px var(--shadow);
}

/* Итоговая зона */
#averageResult {
  margin-top: 30px;
  padding: 24px;
  background: var(--result-bg);
  border-radius: var(--border-radius);
  font-weight: 600;
  color: var(--label-color);
  width: 100%;
  text-align: center;
  box-shadow: var(--card-shadow);
  max-height: 400px;
  overflow-y: auto;
  transition: var(--transition);
}

#averageResult:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--shadow);
}

/* Модальное окно */
#sotModal {
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.5);
  justify-content: center; 
  align-items: center; 
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
}
#sotModal > div {
  background: var(--hover-bg-color);
  padding: 20px;
  border-radius: 8px;
  max-width: 1200px; /* увеличиваем максимальную ширину */
  width: 95%; /* почти на всю ширину экрана */
  max-height: 80vh; /* ограничение по высоте — 80% окна */
  height: auto; /* высота по содержимому */
  overflow: auto; /* при переполнении — прокрутка */
}
#sotModal.show {
  display: flex;
  opacity: 1;
}
#sotIframe {
  width: 100%; 
  max-width: 1200px;
  height: 70vh; 
  border: none; 
  border-radius: 10px;
}
#closeSOTModal {
  align-self: center;
  padding: 10px 20px;
  font-size: 1.2em;
  border: none;
  border-radius: calc(var(--border-radius));
  background: #555;
  color: #fff;
  cursor: pointer;
  transition: background 0.2s;
}
#closeSOTModal:hover {
  background: #333;
}

//* Улучшенные анимации */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
/* Стиль для контейнера истории изменений */
#changelogContainer {
  display: none; /* по умолчанию скрыт, управляется классом */
  position: fixed;
  top: 70px;
  left: 20px;
  width: 420px;
  max-height: 600px;
  overflow-y: auto;
  background: var(--chart-bg-color);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 12px 24px rgba(0,0,0,0.2);
  z-index: 9999;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: var(--text-color);
  transition: opacity 0.3s ease, transform 0.3s ease;
  opacity: 0;
  transform: translateY(-20px);
}
#changelogContainer.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* Заголовок раздела */
#changelogContainer h4 {
  margin-top: 0;
  font-size: 1.8em;
  margin-bottom: 15px;
  font-weight: 700;
  border-bottom: 2px solid #ccc;
  padding-bottom: 10px;
  color: var(--text-color);
}

/* Каждая запись */
.changelog-entry {
  margin-bottom: 15px;
  padding: 15px;
  background: var(--hover-bg-color);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
}
.changelog-entry:hover {
  background: var(--section-bg);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  transform: translateY(-3px);
}

/* Заголовки внутри записи */
.changelog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.changelog-version {
  font-weight: 600;
  font-size: 1.2em;
  color: var(--text-color);
}
.changelog-date {
  font-size: 1em;
  color: var(--changelog-date-color);
}
.changelog-type {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 16px;
  font-size: 0.9em;
  font-weight: 600;
  color: #fff;
  background-color: var(--changelog-type-bg);
  text-transform: uppercase;
}

/* Фон для типов */
.changelog-type.Добавлено { background-color: #27ae60; }
.changelog-type.Исправлено { background-color: #f39c12; }
.changelog-type.Общее { background-color: #8e44ad; }

#bugReportBtn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--section-bg);
  color: var(--text-color);
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  padding: 0; /* убираем любые внутренние отступы */
}
/* Можно убрать font-size у кнопки, оставить только у иконки */
#bugReportBtn i {
  display: block;
  margin: 0;
}
  .buttons {
    display: flex;
    justify-content: center; /* Центрирование по горизонтали */
    gap: 20px; /* Межкнопочное расстояние, по желанию */
  }
h3 {
  font-size: 16px;
}
li {
  font-size: 16px;
}
p {
  font-size: 16px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  font-size: 0.95em;
  font-family: 'Arial', sans-serif;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px 12px;
  text-align: left;
}

th {
  background-color: #e0e0e0;
  font-weight: bold;
}

tr:nth-child(even) {
  background-color: #f9f9f9;
}

tr:hover {
  background-color: #f1f1f1;
}
body.dark table,
body.dark th,
body.dark td {
  background-color: var(--hover-bg-color);
  color: var(--text-color);
  border-color: var(--border-color);
}

/* Можно дополнительно задать стили для заголовков таблиц, чтобы они хорошо смотрелись в тёмной теме */
body.dark th {
  background-color: transparent;
  border-color: var(--border-color);
}
body.dark #comparisonResult {
  background: var(--section-bg);
  color: var(--text-color);
  box-shadow: inset 0 4px 20px rgba(0,0,0,0.5);
  border: 1px solid #555;
}
#compareBtn {
  background: var(--button-bg);
  color: #fff;
  padding: 14px 28px;
  font-size: 1.3em;
  border: none;
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition);
  font-weight: 600;
}
#compareBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
  @keyframes colorShift {
  0% {
    background-position: 0% 50%;
  }
  100% {
    background-position: 100% 50%;
  }
}
/* Общий контейнер модалки */
#bugModal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease, transform 0.3s ease;
  transform: scale(0.95);
}
#bugModal.show {
  display: flex;
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}

/* Внутренний блок */
#bugModal > div {
  background: var(--bg-color);
  padding: 30px;
  border-radius: 16px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 12px 24px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeInUp 0.3s ease forwards;
  transform: translateY(20px);
}
@keyframes fadeInUp {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

/* Заголовок с иконкой */
#bugModal h3 {
  display: flex;
  align-items: center;
  font-size: 1.5em;
  margin-bottom: 20px;
  font-weight: 600;
}
#bugModal h3 i {
  margin-right: 10px;
  color: #f39c12;
  font-size: 1.8em;
}

/* Текстовое поле */
#bugDescription {
  width: 95%;
  height: 150px;
  padding: 15px;
  border-radius: 12px;
  background: var(--hover-bg-color);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  font-family: 'Inter', sans-serif;
  font-size: 1em;
  resize: vertical;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  transition: border-color 0.2s, box-shadow 0.2s;
}
#bugDescription:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.2);
}

/* Кнопки */
#sendBug, #closeBugModal {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
  font-size: 1em;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
#sendBug {
  background: linear-gradient(135deg, #4CAF50, #45A049);
  color: #fff;
}
#sendBug:hover {
  background: linear-gradient(135deg, #43a047, #399f3f);
  box-shadow: 0 6px 14px rgba(0,0,0,0.2);
  transform: translateY(-2px);
}
#closeBugModal {
  background: linear-gradient(135deg, #999, #666);
  color: #fff;
}
#closeBugModal:hover {
  background: linear-gradient(135deg, #777, #444);
  box-shadow: 0 6px 14px rgba(0,0,0,0.2);
  transform: translateY(-2px);
}

/* Кнопки в контейнере */
#bugModal .buttons {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 15px;
}

/* Анимация при наведении на кнопки */
#sendBug:hover, #closeBugModal:hover {
  opacity: 0.9;
}

/* Кнопка закрытия — крестик в правом верхнем углу, если нужно */
.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  background: transparent;
  border: none;
  font-size: 1.8em;
  cursor: pointer;
  color: #999;
  transition: color 0.3s, transform 0.2s;
}
.close-btn:hover {
  color: #333;
  transform: rotate(90deg);
}
/* Стили для снега */
.snow {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 998; /* чуть ниже кнопки или другого контента */
  overflow: hidden;
}

/* Создаем множество снежинок с разными параметрами */
.snow div {
  position: absolute;
  top: -10px; /* начинаем чуть выше, чтобы плавно появлялись */
  opacity: 0.8;
  background: #fff;
  border-radius: 50%;
  width: var(--size);
  height: var(--size);
  box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
  /* Анимации */
  animation: fall var(--duration) linear forwards, drift var(--drift-duration) ease-in-out infinite;
  /* Центр вращения */
  transform-origin: center;
  /* Начальное вращение */
  transform: rotate(var(--initial-rotation));
}
.snowflake {
  position: absolute;
  top: -10px;
  background: #fff;
  border-radius: 50%;
  opacity: 0.8;
  box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
  pointer-events: none;
  z-index: 9998;
}
/* Анимация падения */
@keyframes fall {
  0% {
    transform: translateY(0) rotate(var(--initial-rotation));
    opacity: 0.8;
  }
  80% {
    opacity: 0.8;
  }
  100% {
    transform: translateY(100vh) rotate(calc(var(--initial-rotation) + 360deg));
    opacity: 0;
  }
}

/* Легкое колебание снежинки для реалистичности */
@keyframes drift {
  0% {
    transform: translateX(0);
  }
  50% {
    transform: translateX(var(--drift-x));
  }
  100% {
    transform: translateX(0);
  }
}
.control-panel {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 9999;
  background: var(--bg-color);
  padding: 16px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(100px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}
.control-panel:hover {
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
  transform: translateY(-50%) scale(1.02);
}
.control-btn {
  width: 52px;
  height: 52px;
  background: var(--button-bg);
  color: #fff;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.8em;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  animation: slideIn 1s ease forwards;
  animation-delay: calc(var(--index) * 0.1s);
  opacity: 0;
}
body.dark .control-btn {
  background: linear-gradient(135deg, #444, #222);
}
.control-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0));
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.control-btn:hover {
  transform: translateY(-3px) scale(1.1);
  box-shadow: 0 8px 25px var(--shadow);
}
.control-btn:hover::before {
  opacity: 1;
}
/* Индикатор активного состояния */
.control-btn.active {
  background: linear-gradient(135deg, #4CAF50, #45A049);
  box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
}

/* Тултипы */
.control-btn::after {
  content: attr(title);
  position: absolute;
  right: 60px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--bg-color);
  color: var(--text-color);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 10000;
  pointer-events: none;
}

.control-btn:hover::after {
  opacity: 1;
  visibility: visible;
  right: 65px;
}
#changelogToggle,
#snowToggleBtn,
#instructionToggle,
#themeToggle,
#backHomeBtn {
  font-size: 24px;
  margin: 0;
  position: static;
}
#bugReportBtn {
  background: var(--button-bg);
  color:#fff; 
  border:none; 
  border-radius:50%; 
  width:50px; 
  height:50px; 
  font-size: 24px;
  cursor:pointer; 
  box-shadow:0 4px 8px rgba(0,0,0,0.2); 
  display: block; 
  align-items: center; 
  justify-content: center;
  padding: 0;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
</style>
</head>
<body>
<div class="control-panel">
  <!-- Кнопка переключения темы (Moon / Sun) -->
  <button class="control-btn theme-switch" id="themeToggle" title="Сменить тему">
    <i class="fas fa-moon"></i>
  </button>
  <!-- Changelog -->
  <button class="control-btn" id="changelogToggle" title="История изменений">
    <i class="fas fa-history"></i>
  </button>
  <!-- Инструкция -->
  <button class="control-btn" id="instructionToggle" title="Инструкция">
    <i class="fas fa-info-circle"></i>
  </button>
  <!-- Баг‑репорт -->
  <button class="control-btn" id="bugReportBtn" title="Сообщить о баге">
    <i class="fas fa-comment-dots"></i>
  </button>
  <!-- Остановить/Запустить снег -->
  <button class="control-btn" id="snowToggleBtn" title="Остановить снег">
    <i class="fas fa-snowflake"></i>
  </button>
  <!-- Кнопка «Назад на главную» -->
  <button class="control-btn back-btn" id="backHomeBtn" title="Назад на главную">
    <i class="fas fa-home"></i>
  </button>
  <button class="control-btn" id="toggleInterfaceBtn" title="Переключить интерфейс">
  <i class="fas fa-exchange-alt"></i>
</button>
</div>
<div id="toastContainer" style="
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 15px;
  pointer-events: none;
"></div>
<!-- Инструкция в виде модального окна -->
<div id="instructionModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
  <div style="
    background: var(--hover-bg-color);
    padding: 30px;
    max-width: 800px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    font-family: 'Inter', sans-serif;
    color: var(--text-color);
    position: relative;
  ">
    <h2 style="margin-top:0; font-size: 1.8em; text-align: center; color: var(--text-color);">
  <i class="fas fa-info-circle" style="color: var(--primary-color); margin-right:10px;"></i> Как использовать этот инструмент
</h2>
    <p style="font-size: 1.1em; color: var(--text-color); line-height:1.6; text-align: center;">
      Добро пожаловать! Этот сайт — ваш помощник для анализа и визуализации данных. Ниже — краткая, но яркая инструкция, чтобы вы могли быстро начать работать и получать максимум пользы.
    </p>
    <hr style="margin:20px 0; border: none; border-top: 2px solid #eee;">

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color: var(--text-color); display:flex; align-items:center;">
        <i class="fas fa-cloud-download-alt" style="margin-right:10px; color:#3498db;"></i> Шаг 1: Получение файла СОТ
      </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; color:var(--text-color);">
        <li style="margin-bottom:10px;"><strong>Нажмите "Выгрузить СОТ"</strong>.</li>
        <li style="margin-bottom:10px;">Откроется новая вкладка — входите, если нужно авторизоваться.</li>
        <li style="margin-bottom:10px;">Выберите диапазон дат для выгрузки.</li>
        <li style="margin-bottom:10px;">Нажмите кнопку для скачивания файла и вернитесь сюда.</li>
      </ul>
    </section>

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color:var(--text-color); display:flex; align-items:center;">
        <i class="fas fa-upload" style="margin-right:10px; color:#e67e22;"></i> Шаг 2: Загрузка CSV
      </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; var(--text-color);">
        <li style="margin-bottom:10px;">Кликните "Выберите CSV" и выберите файл с компьютера.</li>
        <li style="margin-bottom:10px;">После загрузки появится подтверждение — можно продолжать.</li>
      </ul>
    </section>

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color:var(--text-color); display:flex; align-items:center;">
        <i class="fas fa-cogs" style="margin-right:10px; color:#1abc9c;"></i> Шаг 3: Настройка параметров
      </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; color:var(--text-color);">
        <li style="margin-bottom:10px;">Выберите сайт, инструмент, режим и сотрудника (если нужно).</li>
        <li style="margin-bottom:10px;">Фильтруйте данные для точного анализа.</li>
      </ul>
    </section>

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color:var(--text-color); display:flex; align-items:center;">
        <i class="fas fa-chart-line" style="margin-right:10px; color:#9b59b6;"></i> Шаг 4: Визуализация данных
      </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; color:var(--text-color);">
        <li style="margin-bottom:10px;">График обновится автоматически — наблюдайте за динамикой.</li>
        <li style="margin-bottom:10px;">Нажмите "Обновить" для ручной перерисовки.</li>
        <li style="margin-bottom:10px;">"ТОП" — покажет лучших сотрудников.</li>
        <li style="margin-bottom:10px;">"Итоги" — даст сводную таблицу за выбранный период.</li>
        <li style="margin-bottom:10px;">Есть возможность построить несколько графиков по разным CSV-файлам одновременно.</li>
        <li style="margin-bottom:10px;">Загрузите необходимое количество файлов CSV в поле "Выберите CSV".</li>
        <li style="margin-bottom:10px;">После загрузки нескольких файлов появится возможность перелистывать графики с помощью кнопок "Предыдущий" и "Следующий".</li>
    </ul>
    </section>

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color:var(--text-color); display:flex; align-items:center;">
  <i class="fas fa-sync-alt" style="margin-right:10px; color:#e74c3c;"></i> 
    <span>Шаг 5: Сравнение выгрузок</span>
    </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; color:var(--text-color);">
        <li style="margin-bottom:10px;">Подготовьте два CSV файла за разные периоды.</li>
        <li style="margin-bottom:10px;">Загрузите первый нажатием или переносом файла на кнопку "Выберите CSV" и нажмите "Сравнить файлы".</li>
        <li style="margin-bottom:10px;">Вам покажут таблицу с процентными изменениями и разницей.</li>
        <li style="margin-bottom:10px;">Нажав кнопку "Показать сравнение графиков" можно увидеть на графике разницу.</li>
      </ul>
   

    <section style="margin-bottom:20px;">
      <h3 style="font-size:1.4em; color:var(--text-color); display:flex; align-items:center;">
        <i class="fas fa-tools" style="margin-right:10px; color:#f39c12;"></i> Дополнительные функции
      </h3>
      <ul style="list-style: none; padding:0; margin-left:0; font-size:1.1em; color:var(--text-color);">
        <li style="margin-bottom:10px;"><strong>Changelog</strong> — следите за обновлениями сайта.</li>
        <li style="margin-bottom:10px;"><strong>Тёмная тема</strong> — переключайте стиль для комфортной работы вечером.</li>
        <li style="margin-bottom:10px;"><strong>Обратная связь</strong> — сообщите о баге или оставьте пожелание, нажав на "сообщение" <i class="fas fa-comment" style="font-size:16px; line-height: 1;"></i>.</li>
        <li style="margin-bottom:10px;"><strong>Инструкция</strong> — всегда можно открыть заново, нажав на иконку "инфо" <i class="fas fa-info-circle" style="font-size: 16px;"></i> .</li>
         <li style="margin-bottom:10px;"><strong>Статус</strong> — следите за статусом сообщения (Bug ID указывается в уведомлении после отправки сообщения).<span style="
      background: linear-gradient(270deg, #ff0000, #ffa500, #ff0000);
      background-size: 600% 600%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 20px;
      font-weight: bold;
      padding: 0 10px;
      animation: colorShift 3s linear infinite;
      display: inline-block;
      margin-right: 10px;
    ">- NEW -</span></li>
      </ul>
    </section>

    <div style="text-align:center; margin-top:30px;">
      <button onclick="document.getElementById('instructionModal').style.display='none'" style="
        font-size:14px; padding:10px 20px; border:none; background:#4CAF50; color:#fff; border-radius:4px; cursor:pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: background 0.3s, transform 0.2s;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';">
        Понятно, спасибо!
      </button>
    </div>
  </div>
</div>
  <!-- Новый футер -->
<div id="footer">
  <span>Создатель сайта: EmPsOn &copy; 2025</span>
</div>
<div style="margin-top: 15px; margin-left: 0px;">
  <button class="back-btn" onclick="window.open('index.html', '_self')">← Назад на главную</button>
</div>
<!-- Переключатель темы -->
<button class="theme-switch" id="themeToggle"><i class="fas fa-moon"></i></button>

<div class="container">
<!-- Блок changelog -->
<div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
  <button id="changelogToggle" style="display: none; padding:15px 30px; border:none; border-radius:10px; background:var(--button-bg); color:#fff; cursor:pointer; font-weight:600; font-size:20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: background 0.3s; border-radius: var(--border-radius);">
    Changelog
  </button>
</div>
<div id="changelogContainer">
  <h4>История изменений</h4>
  <!-- Тут динамически вставляется содержимое -->
</div>
<!-- Контейнер с кнопками, позиционированный фиксировано -->
<div style="position: fixed; bottom: 70px; right: 10px; font-size: 20px; z-index: 9999; display: none; flex-direction: column; gap: 10px; align-items: center;">
  <!-- Кнопка показать инструкцию с иконкой Font Awesome -->
  <button onclick="document.getElementById('instructionModal').style.display='flex'" style="
    background:#f44336; 
    color:#fff; 
    border:none; 
    border-radius:50%; 
    width:50px; 
    height:50px; 
    cursor:pointer; 
    box-shadow:0 4px 8px rgba(0,0,0,0.2); 
    display: block; 
    align-items: center; 
    justify-content: center;
    padding: 0;
  ">
  <i class="fas fa-info-circle" style="margin-right: 0px; font-size: 28px;"></i> 
  <!-- Кнопка баг-репорта -->
  <button id="bugReportBtn" style="
    background:#f44336; 
    color:#fff; 
    border:none; 
    border-radius:50%; 
    width:50px; 
    height:50px; 
    cursor:pointer; 
    box-shadow:0 4px 8px rgba(0,0,0,0.2); 
    display: block; 
    align-items: center; 
    justify-content: center;
    padding: 0;
  ">
    <i class="fas fa-comment" style="font-size:24px; display: block; line-height: 1; text-align: center;"></i>
  </button>
  <button id="snowToggleBtn" style="
    background:#00d2d2; 
    color:#fff; 
    border:none; 
    border-radius:50%; 
    width:50px; 
    height:50px; 
    cursor:pointer; 
    box-shadow:0 4px 8px rgba(0,0,0,0.2); 
    display:flex; 
    align-items:center; 
    justify-content:center;
    font-size:24px;
  " title="Остановить снег">
    <i class="fas fa-snowflake"></i>
  </button>
</div>

<!-- Модальное окно для описания бага -->
<div id="bugModal" class="modal">
<div class="modal-content">
<h3 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-comment"></i>
<span>Сообщить о баге или оставить пожелание</span>
</h3>
<textarea id="bugDescription" placeholder="Опишите проблему или пожелание..."></textarea>
<div style="margin-top:20px; display:flex; justify-content:flex-end; gap:15px;">
<button id="chckst" class="btn" style="font-weight:700; gap: 15px; font-size: 18px; ">Статус</button>
<button id="sendBug" class="btn" style="font-size: 18px;font-weight:700;">Отправить</button>
<button id="closeBugModal" class="btn" style="background: #999; font-size: 18px;font-weight:700;">Отмена</button>
</div>
</div>
</div>

  <!-- Верхняя панель -->
  <div class="top-panel">
    <!-- Загрузка файла -->
    <div class="file-zone">
<label class="file-label" id="exportSOTBtn">
<i class="fas fa-cloud-upload-alt"></i> Выгрузить СОТ
</label>
      <label class="file-label" for="csvFileInput">
        <i class="fas fa-file-csv"></i> Выберите CSV
      </label>
      <input type="file" id="csvFileInput" accept=".csv" multiple />
    </div>
    <!-- Настройки -->
    <div class="settings">
      <div class="setting-box">
        <label for="blockSelect"><i class="fa-solid fa-database"></i> Сайт</label>
        <select id="blockSelect">
          <option value="" disabled selected>выберите CSV</option>
        </select>
      </div>
      <div class="setting-box">
        <label for="toolSelect"><i class="fas fa-wrench"></i> Инструмент</label>
        <select id="toolSelect">
          <option value="" disabled selected>выберите CSV</option>
        </select>
      </div>
      <div class="setting-box">
        <label for="modeSelect"><i class="fas fa-sliders-h"></i> Режим</label>
        <select id="modeSelect">
          <option value="all">Общий</option>
          <option value="individual">По сотруднику</option>
        </select>
      </div>
      <div class="setting-box" id="employeeBox" style="display:none;">
        <label for="employeeSelect"><i class="fas fa-user"></i> Сотрудник</label>
        <select id="employeeSelect"></select>
      </div>
    </div>
  </div>
<div id="fileNamesContainer" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border-radius: 8px;">
  <!-- Названия файлов будут добавляться сюда -->
  <div id="fileList"></div>
</div>
  <!-- График и итог -->
  <div class="chart-section">
    <div id="chartTitle"><i class="fas fa-search"></i> Загрузите файл и выберите параметры</div>
    <div id="chartContainer">
      <canvas id="myChart"></canvas>
    </div>
   <div style="margin-top:20px; display:flex; gap:15px; justify-content:center;">
<button id="prevGraph" class="btn"><i class="fas fa-chevron-left"></i> Предыдущий</button>
<button id="nextGraph" class="btn"><i class="fas fa-chevron-right"></i> Следующий</button>
</div>
    <div class="buttons">
      <button class="btn" id="refreshBtn"><i class="fas fa-rotate"></i> Обновить</button>
      <button class="btn" id="topBtn"><i class="fas fa-star"></i> ТОП</button>
     <button class="btn" id="summaryBtn"><i class="fas fa-chart-pie"></i> Итоги</button>
<button id="compareGraphsBtn" class="btn">
  <i class="fas fa-chart-line"></i>Показать сравнение графиков</button>
    </div>
    <div id="averageResult"></div>
  </div>

</div>
<!-- Модальное окно для поиска Bug ID -->
<div id="bugIdModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999;">
  <div style="background: var(--hover-bg-color); padding: 20px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 8px 20px rgba(0,0,0,0.3);">
    <h3 style="margin-top:0;">Поиск Bug ID</h3>
    <i class="fas fa-search" style="font-size:1.5em; color:var(--text-color);"></i>
    <input type="text" id="bugIdInput" placeholder="Введите Bug ID" style="color: var(--text-color); background: var(--hover-bg-color); width:94%; padding:10px; font-size:1em; border-radius:8px; border:1px solid #ccc;"/>
    <div id="recentBugIds" style="
  margin-top: 15px;
  padding: 10px 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background-color: var(--hover-bg-color);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-size: 14px;
  color: var(--text-color);
  max-height: 150px;
  overflow-y: auto;
  transition: all 0.3s ease;
"></div>
    <div id="bugStatusResult" style="margin-top: 15px; font-weight: 600; font-size: 16px; color: #333;"></div>
    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button id="searchBugId" style="padding:12px 16px; border:none; border-radius:15px; font-size: 18px; background:#4CAF50; cursor:pointer; font-weight:700; color:#fff;">Поиск</button>
      <button id="closeBugIdModal" style="padding:12px 15px; border:none; font-size: 18px; border-radius:15px; background:#999; color:#fff; cursor:pointer;font-weight:700;">Закрыть</button>
    </div>
  </div>
</div>

<!-- Модальное окно -->
<div id="sotModal">
  <div>
    <iframe id="sotIframe" src="https://s-o-t.ru/netcat/?catalogue=1&sub=1891833"></iframe>
    <button class="btn" id="closeSOTModal"><i class="fas fa-times"></i> Закрыть</button>
  </div>
</div>
<label class="file-label" for="csvFileInput2" style="z-index: 2; margin-left: 120px; width: 300px;">
<i class="fas fa-file-csv"></i> Загрузите второй CSV
</label>
<input type="file" id="csvFileInput2" accept=".csv" style="display:none;" />
<button id="compareBtn" class="btn" style="display: none; margin: 20px auto; max-width: 300px;">
<i class="fas fa-code-compare"></i> Сравнить файлы
</button>
<div id="comparisonResult" style="
  margin-top: 30px;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  max-height: 500px;
  overflow-y: auto;
  font-family: 'Arial', sans-serif;
  margin-bottom: 80px;
  transition: box-shadow 0.3s;
  display: none;
">
  <h3 style="margin-top:0; text-align:center; font-size:1.8em; color:var(--text-color);">Результаты сравнения</h3>
  <div style="margin-bottom: 20px; text-align: center;">
</div>
  <div id="comparisonContent" style="margin-top:10px; line-height:1.6;">
      <!-- Здесь будут таблицы -->
  </div>
</div>
<script>
let dataBlocks = {
    SOT: { labels: [], data: {} },
    PMK: { labels: [], data: {} },
    TORUDA: { labels: [], data: {} }
};
let currentBlock = null;
let currentTool = null;
let currentEmployee = null;
let chartInstance = null;
let currentLabels = [];
let currentDatasets = [];
let csvFilesData = [];
let currentCsvIndex = -1; // индекс текущего файла
let fileNames = [];
let snowContainer = null;
let snowInterval = null;
let snowActive = false;
let easterEggCount = 0;
let bugIdHistory = [];
function showNotification(message) {
  // Создаем элемент уведомления
  const notification = document.createElement('div');
  notification.innerText = message;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.left = '50%';
  notification.style.transform = 'translateX(-50%)';
  notification.style.backgroundColor = 'rgba(0,0,0,0.8)';
  notification.style.color = '#fff';
  notification.style.padding = '15px 20px';
  notification.style.borderRadius = '8px';
  notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
  notification.style.zIndex = '10000';
  notification.style.fontSize = '14px';
  notification.style.opacity = '0';
  notification.style.transition = 'opacity 0.3s';

  document.body.appendChild(notification);

  // Анимация появления
  setTimeout(() => {
    notification.style.opacity = '1';
  }, 10);

  // Удаление через 3 секунды
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
// =====================
// Инициализация темы из localStorage
// =====================
let darkMode = false; // глобальная переменная для темы
window.addEventListener('load', () => {
  const savedTheme = localStorage.getItem('theme');
  const themeBtn = document.getElementById('themeToggle');
  if (savedTheme === 'dark') {
    darkMode = true;
    document.body.classList.add('dark');
    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #111, #222)'
    );
  } else {
    // светлая тема
    darkMode = false;
    document.body.classList.remove('dark');
    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #f0f2f5, #d9e2ef)'
    );
  }
  updateChart(); // обновим график под тему
});
const stored = localStorage.getItem('bugIdHistory');
  if (stored) {
    try {
      bugIdHistory = JSON.parse(stored);
      // преобразуем строки в объекты с датами
      bugIdHistory = bugIdHistory.map(entry => ({
        id: entry.id,
        timestamp: new Date(entry.timestamp)
      }));
    } catch(e) {
      bugIdHistory = [];
    }
  }
// =====================
// Обработчик переключения темы
// =====================
const themeBtn = document.getElementById('themeToggle');
themeBtn.onclick = () => {
  darkMode = !darkMode;
  if (darkMode) {
    document.body.classList.add('dark');
    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #111, #222)'
    );
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark');
    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #f0f2f5, #d9e2ef)'
    );
    localStorage.setItem('theme', 'light');
  }
  updateChart();
  showToast('Тема изменена');
};

// =====================
// Обработка файла
// =====================
const fileInput = document.getElementById('csvFileInput');
const blockSelect = document.getElementById('blockSelect');
const toolSelect = document.getElementById('toolSelect');
let fileChosen = false;
let savedToolSelection = ''; // переменная для хранения выбранного инструмента

// Обработчик выбора файлов
fileInput.addEventListener('change', () => {
  const files = fileInput.files;
  if (!files || files.length === 0) return;

  // Очищаем старые данные
  csvFilesData = [];
  fileNames = [];
  document.getElementById('fileNamesContainer').innerHTML = '';
  let loadedCount = 0;

  // Загружаем все выбранные файлы
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!file.name.endsWith('.csv')) continue;

    fileNames.push(file.name); // сохраняем имя файла

    const reader = new FileReader();
    reader.onload = e => {
      // Добавляем содержимое файла в массив
      csvFilesData.push(e.target.result);
      loadedCount++;
      
      // Когда все файлы загружены
      if (loadedCount === files.length) {
        currentCsvIndex = 0; // начинаем с первого файла
        processCSV(csvFilesData[currentCsvIndex]);
        updateGraphSwitchButtons();
        updateChart();

        // Обновляем список названий файлов
        renderFileNames();

        // Обновляем UI
        document.getElementById('chartTitle').innerHTML = '<i class="fas fa-check-circle"></i> Данные загружены. Выберите параметры';
        document.getElementById('averageResult').innerHTML = '';
        document.getElementById('modeSelect').value = 'all';
        toggleEmployeeSelection();
        showToast(`Загружено ${csvFilesData.length} файла(ов)`, 'success');
      }
    };
    reader.readAsText(file);
  }
  // После выбора файлов очищаем опции, если нужно
  if (!fileChosen) {
    blockSelect.innerHTML = '';
    toolSelect.innerHTML = '';
  }
  fileChosen = true;
});


// =====================
// Функции для выбора и обработки CSV
// =====================
function resetSelects() {
  // Возвращаем опцию "выберите CSV"
  blockSelect.innerHTML = '<option value="" disabled selected>выберите CSV</option>';
  toolSelect.innerHTML = '<option value="" disabled selected>выберите CSV</option>';
}

function updateBlockOptions() {
  const select = document.getElementById('blockSelect');
  select.innerHTML = '';
  for (const b in dataBlocks) {
    const option = document.createElement('option');
    option.value = b;
    option.textContent = b;
    select.appendChild(option);
  }
  select.onchange = () => {
    selectBlock(select.value);
    toggleEmployeeSelection();
    updateChart();
  };
}

function selectBlock(name) {
  currentBlock = name;
  const blockData = dataBlocks[name];
  const tools = Object.keys(blockData.data);
  const selectTool = document.getElementById('toolSelect');
  const selectEmp = document.getElementById('employeeSelect');

  // Запоминаем текущий выбранный инструмент, если есть
  const previousTool = savedToolSelection;

  selectTool.innerHTML = '';
  selectEmp.innerHTML = '';

  // Заполняем инструменты
  for (const t of tools) {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    // Если есть сохраненный инструмент, выбираем его
    if (t === previousTool) {
      opt.selected = true;
    }
    selectTool.appendChild(opt);
  }

  // Заполняем сотрудников
  const employees = new Set();
  tools.forEach(t => {
    Object.keys(blockData.data[t] || {}).forEach(e => employees.add(e));
  });
  const empArr = Array.from(employees).sort();

  empArr.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e;
    opt.textContent = e;
    selectEmp.appendChild(opt);
  });

  // Обработка выбора инструмента
  selectTool.onchange = () => {
    currentTool = selectTool.value;
    savedToolSelection = currentTool; // сохраняем выбранный инструмент
    updateChart();
  };

  // Обработка выбора сотрудника
  selectEmp.onchange = () => {
    currentEmployee = selectEmp.value;
    updateChart();
  };

  // Обработка режима
  document.getElementById('modeSelect').onchange = toggleEmployeeSelection;
  // Устанавливаем режим по умолчанию
  document.getElementById('modeSelect').value = 'all';
  toggleEmployeeSelection();

  // Устанавливаем текущий выбранный инструмент и сотрудника
  if (tools.length > 0) {
    // если есть сохраненный инструмент, он уже выбран
    if (savedToolSelection && tools.includes(savedToolSelection)) {
      currentTool = savedToolSelection;
    } else {
      currentTool = tools[0];
    }
    document.getElementById('toolSelect').value = currentTool;

    // выбираем первого сотрудника
    if (empArr.length > 0) {
      currentEmployee = empArr[0];
      document.getElementById('employeeSelect').value = currentEmployee;
    }

    updateChart();
    document.getElementById('chartTitle').innerHTML = '<i class="fas fa-layer-group"></i> ' + name + ' | ' + currentTool;
  } else {
    if (chartInstance) chartInstance.destroy();
  }
}

function toggleEmployeeSelection() {
  const mode = document.getElementById('modeSelect').value;
  document.getElementById('employeeBox').style.display = (mode === 'individual') ? 'flex' : 'none';
  updateChart();
}

function parseDate(str) {
  const parts = str.trim().split('.');
  if (parts.length !== 3) return null;
  let [d, m, y] = parts;
  if (y.length === 2) y = '20' + y;
  return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
}

function processCSV(text) {
  dataBlocks = {
    SOT: { labels: [], data: {} },
    PMK: { labels: [], data: {} },
    TORUDA: { labels: [], data: {} }
  };
  const lines = text.trim().split(/\r?\n/);
  const pmkIdx = lines.findIndex(l => l.includes("PMK"));
  const torIdx = lines.findIndex(l => l.includes("TORUDA"));

  const SOTLines = lines.slice(0, pmkIdx);
  const PMKLines = lines.slice(pmkIdx, torIdx);
  const TORUDALines = lines.slice(torIdx);

  ['SOT', 'PMK', 'TORUDA'].forEach(block => {
    let blockLines;
    if (block === 'SOT') blockLines = SOTLines;
    else if (block === 'PMK') blockLines = PMKLines;
    else blockLines = TORUDALines;

    const parsedData = {};
    const dateSet = new Set();

    for (const line of blockLines) {
      const cols = line.split(';').map(c => c.trim());
      if (cols.length < 7) continue;
      const [person, tool, , , , , dateStr] = cols;
      const dateLabel = parseDate(dateStr);
      if (!dateLabel) continue;
      dateSet.add(dateLabel);
      const values = [];
      for (let i = 2; i <= 5; i++) {
        const v = parseFloat(cols[i].replace(',', '.')) || 0;
        values.push(v);
      }
      const total = values.reduce((a, b) => a + b, 0);
      if (!parsedData[tool]) parsedData[tool] = {};
      if (!parsedData[tool][person]) parsedData[tool][person] = {};
      if (!parsedData[tool][person][dateLabel]) parsedData[tool][person][dateLabel] = 0;
      parsedData[tool][person][dateLabel] += total;
    }
    const labelsArr = Array.from(dateSet).sort((a, b) => new Date(a) - new Date(b));
    const dataPerTool = {};
    for (const t in parsedData) {
      dataPerTool[t] = {};
      for (const p in parsedData[t]) {
        dataPerTool[t][p] = Array(labelsArr.length).fill(0);
        labelsArr.forEach((d, i) => {
          if (parsedData[t][p][d] !== undefined) {
            dataPerTool[t][p][i] = parsedData[t][p][d];
          }
        });
      }
    }
    dataBlocks[block].labels = labelsArr;
    dataBlocks[block].data = dataPerTool;
  });
  showToast('Данные успешно загружены!', 'success');
  updateBlockOptions();
  const firstBlock = Object.keys(dataBlocks)[0];
  if (firstBlock) {
    selectBlock(firstBlock);
    toggleEmployeeSelection();
    updateChart();
  }
}

function getChartTextColor() {
  return darkMode ? '#fff' : '#000';
}

function updateChart() {
  const ctx = document.getElementById('myChart').getContext('2d');
  const mode = document.getElementById('modeSelect').value;
  const tool = document.getElementById('toolSelect').value;
  const employee = document.getElementById('employeeSelect').value;
  const blockData = dataBlocks[currentBlock];

  if (!blockData) return;

  const labels = blockData.labels;
  const textColor = getChartTextColor();

  currentLabels = labels;

  // Обновляем заголовок графика
  const titleElem = document.getElementById('chartTitle');
  if (currentBlock && currentTool) {
    titleElem.innerHTML = `<i class="fas fa-layer-group"></i>${currentBlock} | ${currentTool}`;
  } else {
    titleElem.innerHTML = 'Загрузите файл и выберите параметры';
  }

  if (mode === 'all') {
    const persons = Object.keys(blockData.data[tool] || {});
    currentDatasets = persons.map((p, i) => ({
      label: p,
      data: blockData.data[tool][p],
      borderColor: getColor(i),
      backgroundColor: getColor(i, 0.2),
      borderWidth: 2,
      tension: 0.4,
      fill: true,
      pointBackgroundColor: getColor(i),
      pointBorderColor: '#fff'
    }));
  } else {
    if (employee && blockData.data[tool][employee]) {
      currentDatasets = [{
        label: employee,
        data: blockData.data[tool][employee],
        borderColor: getColor(0),
        backgroundColor: getColor(0, 0.2),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: getColor(0),
        pointBorderColor: '#fff'
      }];
    } else {
      currentDatasets = [];
    }
  }

  if (chartInstance) {
    // Обновляем данные и заголовок
    chartInstance.data.labels = labels;
    chartInstance.data.datasets = currentDatasets;

    // Обновляем заголовок графика, чтобы он соответствовал теме
    chartInstance.options.plugins.title = {
      display: true,
      text: document.getElementById('chartTitle').innerText || 'График',
      color: getChartTextColor(),
      font: { size: 16, weight: 'bold' }
    };

    chartInstance.options.plugins.title.color = getChartTextColor();
    chartInstance.options.plugins.legend.labels.color = getChartTextColor();
    chartInstance.options.scales.x.ticks.color = getChartTextColor();
    chartInstance.options.scales.y.ticks.color = getChartTextColor();
    chartInstance.options.scales.x.title.color = getChartTextColor();
    chartInstance.options.scales.y.title.color = getChartTextColor();

    chartInstance.update();
  } else {
    // Создаем новый график
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: currentDatasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1500,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: { position: 'top', labels: { color: getChartTextColor() } },
      title: { display: true, text: 'График', color: getChartTextColor() },
      zoom: {
        pan: {
          enabled: true,
          mode: 'xy'
        },
        zoom: {
          wheel: {
            enabled: true
          },
          pinch: {
            enabled: true
          },
          mode: 'x'
        }
      }
    },
        scales: {
          x: {
            ticks: {
              color: getChartTextColor(),
              font: { size: 14, weight: '600' }
            },
            grid: {
              color: getGridColor(),
              drawBorder: false
            },
            title: {
              display: true,
              text: '📅 Даты',
              color: getChartTextColor(),
              font: { size: 14, weight: '600' }
            }
          },
          y: {
            ticks: {
              color: getChartTextColor(),
              font: { size: 14, weight: '600' }
            },
            grid: {
              color: getGridColor(),
              drawBorder: false
            },
            title: {
              display: true,
              text: 'Значение',
              color: getChartTextColor(),
              font: { size: 14, weight: '600' }
            }
          }
        },
        layout: {
          padding: {
            top: 20,
            bottom: 20,
            left: 20,
            right: 20
          }
        }
      }
    });
  }
}

function getColor(idx, alpha=1) {
  const palette = [
    `rgba(255, 99, 132, ${alpha})`,
    `rgba(54, 162, 235, ${alpha})`,
    `rgba(255, 206, 86, ${alpha})`,
    `rgba(75, 192, 192, ${alpha})`,
    `rgba(153, 102, 255, ${alpha})`,
    `rgba(255, 159, 64, ${alpha})`,
    `rgba(199, 199, 199, ${alpha})`,
    `rgba(255, 99, 255, ${alpha})`,
    `rgba(0, 191, 255, ${alpha})`,
    `rgba(255, 215, 0, ${alpha})`
  ];
  return palette[idx % palette.length];
}

function getGridColor() {
  return getComputedStyle(document.body).getPropertyValue('--chart-text-color').trim();
}

// =====================
// Обработчики
// =====================
document.getElementById('refreshBtn').addEventListener('click', () => { updateChart(); });
document.getElementById('topBtn').addEventListener('click', showTopEmployees);
document.getElementById('exportSOTBtn').onclick = () => {
  document.getElementById('sotModal').classList.add('show');
};
document.getElementById('closeSOTModal').onclick = () => {
  document.getElementById('sotModal').classList.remove('show');
};
document.getElementById('sotModal').onclick = e => {
  if (e.target === document.getElementById('sotModal')) {
    document.getElementById('sotModal').classList.remove('show');
  }
};

// ТОП сотрудников
function showTopEmployees() {
  if (!dataBlocks[currentBlock]) return;
  const blockData = dataBlocks[currentBlock];
  const tool = document.getElementById('toolSelect').value;
  const mode = document.getElementById('modeSelect').value;

  const sums = {};
  for (const emp in blockData.data[tool]) {
    sums[emp] = blockData.data[tool][emp].reduce((a, b) => a + b, 0);
  }

  const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);
  const top3 = sorted.slice(0, 3);
  const trophyIcon = '<i class="fas fa-trophy" style="color: #FFD700; font-size: 1.8em; margin-right: 10px;"></i>';
const icons = [
  '<i class="fas fa-trophy" style="color:gold; font-size:1.4em;"></i>',
  '<i class="fas fa-medal" style="color:silver; font-size:1.4em;"></i>',
  '<i class="fas fa-award" style="color:#cd7f32; font-size:1.4em;"></i>'
];
  let html = `<h3>${trophyIcon} ТОП сотрудников по инструменту: ${tool}</h3><ol style="list-style:none; padding-left:0;">`;
  top3.forEach((item, i) => {
    html += `<li style="margin:8px 0; font-size:1.4em;">${icons[i]} <strong>${item[0]}</strong> — ${item[1].toFixed(2)}</li>`;
  });
  html += '</ol>';
  document.getElementById('averageResult').innerHTML = html;
}
document.getElementById('summaryBtn').addEventListener('click', () => {
  // Получаем текущие параметры
  const block = currentBlock;
  const mode = document.getElementById('modeSelect').value;
  const tool = document.getElementById('toolSelect').value;
  const blockData = dataBlocks[block];

  if (!blockData || !blockData.labels || !blockData.data || !blockData.data[tool]) {
    showToast('Нет данных для расчёта итогов.', 'error');
    return;
  }

  const labels = blockData.labels; // даты
  const employeesData = blockData.data[tool]; // все сотрудники и их данные
  let html = '<h3 style="font-weight: 800; font-size: 20px;">Итоги по сотрудникам за период</h3>';

  // Проходим по сотрудникам и считаем суммы
  let summaries = [];
  for (const emp in employeesData) {
    // Если режим "по сотруднику" или "общий" — считаем
    let totalSum = 0;
    employeesData[emp].forEach(value => {
      totalSum += value;
    });
    summaries.push({ name: emp, sum: totalSum });
  }

  // Сортируем по сумме
  summaries.sort((a, b) => b.sum - a.sum);

  // Формируем таблицу
  html += '<table style="width:100%; border-collapse: collapse; text-align: left;">';
  html += '<tr><th style="border:1px solid #ccc; padding:8px; font-weight: 800; font-size: 20px;">Фамилия, Имя</th><th style="border:1px solid #ccc; padding:8px; font-weight: bold; font-size: 20px;">Сумма</th></tr>';

  summaries.forEach(item => {
    html += `<tr>
      <td style="border:1px solid #ccc; padding:8px; font-weight: 500; font-size: 18px;">${item.name}</td>
      <td style="border:1px solid #ccc; padding:8px; font-weight: 500; font-size: 18px;">${item.sum.toFixed(2)}</td>
    </tr>`;
  });
  html += '</table>';

  // Выводим
  document.getElementById('averageResult').innerHTML = html;
});
// =====================
// Загрузка истории изменений с гугл таблицы
// =====================
const sheetUrl = 'https://docs.google.com/spreadsheets/d/11i0Nwwbw09aJQFNkztrAUfx0G8PXzUfg1sZyjeIKjxQ/gviz/tq?sheet=Лист2';

function loadChangelogFromSheet() {
  fetch(sheetUrl)
    .then(response => response.text())
    .then(text => {
      const jsonData = JSON.parse(text.substring(47).slice(0, -2));
      const rows = jsonData.table.rows;
      let entriesHtml = '';

      function formatDateToDDMMYY(dateStr) {
        const dateMatch = /Date\((\d+),\s*(\d+),\s*(\d+)\)/.exec(dateStr);
        if (dateMatch) {
          let year = parseInt(dateMatch[1], 10);
          let month = parseInt(dateMatch[2], 10);
          let day = parseInt(dateMatch[3], 10);
          month += 1;
          const dd = day.toString().padStart(2, '0');
          const mm = month.toString().padStart(2, '0');
          const yy = (year % 100).toString().padStart(2, '0');
          return `${dd}.${mm}.${yy}`;
        }
        return dateStr;
      }

      rows.forEach(row => {
        const version = row.c[0].v;
        const rawDate = row.c[1].v;
        const date = formatDateToDDMMYY(rawDate);
        const type = row.c[2].v.trim();
        let description = row.c[3].v;
        description = description.replace(/^•\s?/gm, '<li>•</li>');
        const descriptionHtml = description
          .split('\n')
          .map(line => line.trim().startsWith('•') ? `<li>${line.trim()}</li>` : `<p>${line.trim()}</p>`)
          .join('');
        entriesHtml += `
          <div class="changelog-entry">
            <div class="changelog-header">
              <div>
                <span class="changelog-version">Версия ${version}</span>
                <span class="changelog-date">[${date}]</span>
              </div>
              <div class="changelog-type ${type}">${type}</div>
            </div>
            <ul style="margin:0; padding-left:20px;">${descriptionHtml}</ul>
          </div>`;
      });
      document.getElementById('changelogContainer').innerHTML = '<h4 style="margin-top:0;">История изменений</h4>' + entriesHtml;
    })
    .catch(() => {
      document.getElementById('changelogContainer').innerHTML = 'Не удалось загрузить историю изменений.';
    });
}

// =====================
// Загрузка истории при старте
// =====================
window.addEventListener('load', () => {
    document.getElementById('instructionModal').style.display = 'flex';
     if (isSnowPeriod()) {
    startSnow();
    document.getElementById('snowToggleBtn').innerHTML = '<i class="fas fa-snowflake"></i>';
    document.getElementById('snowToggleBtn').title = 'Остановить снег';
  }
    const savedCsv = localStorage.getItem('csvData');
  if (savedCsv) {
    processCSV(savedCsv);
    document.getElementById('chartTitle').innerHTML = '<i class="fas fa-check-circle"></i> Данные загружены. Выберите параметры';
    document.getElementById('averageResult').innerHTML = '';
    document.getElementById('modeSelect').value = 'all';
    toggleEmployeeSelection();
    updateChart();
  }
  loadChangelogFromSheet();
  // Восстановление темы из localStorage
  const savedTheme = localStorage.getItem('theme');
  const themeBtn = document.getElementById('themeToggle');
  if (savedTheme === 'dark') {
    darkMode = true;
    document.body.classList.add('dark');
    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #111, #222)'
    );
  } else {
    darkMode = false; 
    document.body.classList.remove('dark');
    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #f0f2f5, #d9e2ef)'
    );
  }
  // Также можно обновить график, если нужно
  updateChart();
});

// =====================
// Обработчик для кнопки "Changelog"
const changelogBtn = document.getElementById('changelogToggle');
const changelogContainer = document.getElementById('changelogContainer');

changelogBtn.addEventListener('click', () => {
  if (changelogContainer.classList.contains('show')) {
    changelogContainer.classList.remove('show');
  } else {
    loadChangelogFromSheet();
    changelogContainer.classList.add('show');
    showToast('Спасибо за прочтение истории изменений');
  }
});

// =====================
// Обработчик окна баг-репорта
// =====================
document.getElementById('bugReportBtn').addEventListener('click', () => {
  document.getElementById('bugModal').classList.add('show');
});
document.getElementById('closeBugModal').addEventListener('click', () => {
  document.getElementById('bugModal').classList.remove('show');
});
// Обработка отправки бага
const BUG_REPORT_URL = 'https://script.google.com/macros/s/AKfycbyMukNiNzcTtsmydQQJZeJJpVL3lsI17Oy8h_kDliY4WJybvSDZxM6-MS8GFzniKbuu/exec';
const bugId = 'BUG-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
document.getElementById('sendBug').addEventListener('click', () => {
  let description = document.getElementById('bugDescription').value.trim();
  if (description === '') {
    showToast('Пожалуйста, опишите проблему или пожелание.', 'info');
    return;
  }

  // Добавляем конкретную ссылку и bugId в описание
  const sourceLink = 'https://sagatheror.github.io/instrumenti/graph.html';
  description += `\nИсточник: ${sourceLink}\nBug ID: ${bugId}`;

  // Отправляем POST-запрос
  fetch(BUG_REPORT_URL, {
    method: 'POST',
    contentType: 'application/json',
    body: JSON.stringify({description: description, bugId: bugId})
  })
  .then(response => response.json())
  .then(data => {
    console.log('Ответ сервера:', data);
    if (data.result === 'success') {
    // Добавляем Bug ID в историю
    bugIdHistory.unshift({
      id: bugId,
      timestamp: new Date()
    });
    // Ограничиваем длину истории (например, 20 последних)
    if (bugIdHistory.length > 20) bugIdHistory.pop();
    localStorage.setItem('bugIdHistory', JSON.stringify(bugIdHistory));
      console.log('Уведомление появится');
      showToast('Сообщение отправлено. Bug ID: ' + bugId, 'success');
    } else {
      showToast('Произошла ошибка при отправке сообщения', 'error');
    }
  });

  // Очистка поля
  document.getElementById('bugDescription').value = '';
  document.getElementById('bugModal').classList.remove('show');

});
// =====================
// Прозрачность кнопок при прокрутке
// =====================
window.addEventListener('scroll', () => {
    // 1️⃣ Выбираем все кнопки, которые находятся в панели
    const btns = document.querySelectorAll('.control-btn');

    // 2️⃣ Параметры (можете менять под себя)
    const scrollY   = window.scrollY || window.pageYOffset;
    const maxScroll = 300;          // до какой высоты меняем
    const minOpacity = 0.1;         // минимум прозрачности
    const maxOpacity = 1;           // максимум

    // 3️⃣ Вычисляем нужную степень прозрачности
    let opacity = maxOpacity - (scrollY / maxScroll) * (maxOpacity - minOpacity);
    if (opacity < minOpacity) opacity = minOpacity;
    if (opacity > maxOpacity) opacity = maxOpacity;

    // 4️⃣ Применяем к каждой кнопке
    btns.forEach(btn => {
        btn.style.opacity = opacity;
    });
});
// Обработка второго файла
const fileInput2 = document.getElementById('csvFileInput2');

fileInput2.addEventListener('change', () => {
  const file = fileInput2.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    dataBlocksSecond = { SOT: { labels: [], data: {} }, PMK: { labels: [], data: {} }, TORUDA: { labels: [], data: {} } };
    processCSVSecond(e.target.result);
    showToast('Второй файл загружен. Можно произвести сравнение', 'info');
  };
  reader.readAsText(file);
});

// Функция для обработки второго файла
function processCSVSecond(text) {
  // Аналогично processCSV, только для второго файла
  dataBlocksSecond = { SOT: { labels: [], data: {} }, PMK: { labels: [], data: {} }, TORUDA: { labels: [], data: {} } };
  const lines = text.trim().split(/\r?\n/);
  const pmkIdx = lines.findIndex(l => l.includes("PMK"));
  const torIdx = lines.findIndex(l => l.includes("TORUDA"));

  const SOTLines = lines.slice(0, pmkIdx);
  const PMKLines = lines.slice(pmkIdx, torIdx);
  const TORUDALines = lines.slice(torIdx);

  ['SOT', 'PMK', 'TORUDA'].forEach(block => {
    let blockLines;
    if (block === 'SOT') blockLines = SOTLines;
    else if (block === 'PMK') blockLines = PMKLines;
    else blockLines = TORUDALines;

    const parsedData = {};
    const dateSet = new Set();

    for (const line of blockLines) {
      const cols = line.split(';').map(c => c.trim());
      if (cols.length < 7) continue;
      const [person, tool, , , , , dateStr] = cols;
      const dateLabel = parseDate(dateStr);
      if (!dateLabel) continue;
      dateSet.add(dateLabel);
      const values = [];
      for (let i = 2; i <= 5; i++) {
        const v = parseFloat(cols[i].replace(',', '.')) || 0;
        values.push(v);
      }
      const total = values.reduce((a, b) => a + b, 0);
      if (!parsedData[tool]) parsedData[tool] = {};
      if (!parsedData[tool][person]) parsedData[tool][person] = {};
      if (!parsedData[tool][person][dateLabel]) parsedData[tool][person][dateLabel] = 0;
      parsedData[tool][person][dateLabel] += total;
    }
    const labelsArr = Array.from(dateSet).sort((a, b) => new Date(a) - new Date(b));
    const dataPerTool = {};
    for (const t in parsedData) {
      dataPerTool[t] = {};
      for (const p in parsedData[t]) {
        dataPerTool[t][p] = Array(labelsArr.length).fill(0);
        labelsArr.forEach((d, i) => {
          if (parsedData[t][p][d] !== undefined) {
            dataPerTool[t][p][i] = parsedData[t][p][d];
          }
        });
      }
    }
    dataBlocksSecond[block].labels = labelsArr;
    dataBlocksSecond[block].data = dataPerTool;
  });
}

function compareCSVData() {
  if (!dataBlocks || !dataBlocksSecond) {
    showToast('Загрузите оба файла для сравнения', 'info');
    return;
  }

  const container = document.getElementById('comparisonContent');
  container.innerHTML = ''; // очищаем перед выводом

  for (const blockName in dataBlocks) {
    const block1 = dataBlocks[blockName];
    const block2 = dataBlocksSecond[blockName];
    if (!block1 || !block2) continue;

    // Внутри каждого блока выводим таблицу
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.innerHTML = `
      <thead>
        <tr>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Сайт</th>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Инструмент</th>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Сотрудник</th>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Файл 1</th>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Файл 2</th>
          <th style="border:1px solid #ccc; padding:8px; background:var(--hover-bg-color);">Изменение (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');

    const tools = Object.keys(block1.data);
    tools.forEach(tool => {
      const employees1 = Object.keys(block1.data[tool] || {});
      const employees2 = Object.keys(block2.data[tool] || {});
      const allEmployees = new Set([...employees1, ...employees2]);
      
      allEmployees.forEach(employee => {
        const data1 = (block1.data[tool][employee] || Array(block1.labels.length).fill(0));
        const data2 = (block2.data[tool][employee] || Array(block2.labels.length).fill(0));
        const sum1 = data1.reduce((a, b) => a + b, 0);
        const sum2 = data2.reduce((a, b) => a + b, 0);
        const percentChange = sum1 === 0 ? (sum2 === 0 ? 0 : 100) : ((sum2 - sum1) / sum1) * 100;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="border:1px solid #ccc; padding:8px;">${blockName}</td>
          <td style="border:1px solid #ccc; padding:8px;">${tool}</td>
          <td style="border:1px solid #ccc; padding:8px;">${employee}</td>
          <td style="border:1px solid #ccc; padding:8px; text-align:right;">${sum1.toFixed(2)}</td>
          <td style="border:1px solid #ccc; padding:8px; text-align:right;">${sum2.toFixed(2)}</td>
          <td style="border:1px solid #ccc; padding:8px; text-align:right;">${percentChange.toFixed(2)}%</td>
        `;
        tbody.appendChild(row);
      });
    });

    container.appendChild(table);
  }
  showToast('Сравнение завершено', 'success');
}
document.getElementById('compareBtn')?.addEventListener('click', compareCSVData);
// Обработки перетаскивания для первого файла
const dropZoneCSV = document.querySelector('.file-zone');
const inputCSV = document.getElementById('csvFileInput');

dropZoneCSV.addEventListener('dragover', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV.style.border = '2px dashed #333'; // визуальный эффект
});
dropZoneCSV.addEventListener('dragleave', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV.style.border = ''; // убрать эффект
});
dropZoneCSV.addEventListener('drop', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV.style.border = '';

  if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      inputCSV.files = e.dataTransfer.files; // присвоить файлы
      // триггерим change событие, чтобы обработать файл
      inputCSV.dispatchEvent(new Event('change'));
    } else {
      showToast('Пожалуйста, перетщите CSV-файл.', 'info');
    }
  }
});

// Аналогично для второго файла
const inputCSV2 = document.getElementById('csvFileInput2');
const dropZoneCSV2 = document.querySelector('label[for="csvFileInput2"]');

dropZoneCSV2.addEventListener('dragover', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV2.style.border = '2px dashed #333';
});
dropZoneCSV2.addEventListener('dragleave', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV2.style.border = '';
});
dropZoneCSV2.addEventListener('drop', (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZoneCSV2.style.border = '';

  if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      inputCSV2.files = e.dataTransfer.files;
      inputCSV2.dispatchEvent(new Event('change'));
    } else {
      showToast('Пожалуйста, перетащите CSV-файл', 'info');
    }
  }
});
function showToast(message, type='info') {
  const container = document.getElementById('toastContainer');

  const toast = document.createElement('div');
  toast.style.minWidth = '350px';
  toast.style.maxWidth = '400px';
  toast.style.padding = '16px 24px';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 8px 20px rgba(0,0,0,0.3)';
  toast.style.display = 'flex';
  toast.style.alignItems = 'center';
  toast.style.justifyContent = 'space-between';
  toast.style.background = 'linear-gradient(135deg, #667eea, #764ba2)'; // градиент
  toast.style.color = '#fff';
  toast.style.fontSize = '1.2em';
  toast.style.fontWeight = '600';
  toast.style.transition = 'opacity 0.4s, transform 0.4s, box-shadow 0.4s';
  toast.style.pointerEvents = 'auto';
  toast.style.transform = 'translateY(-30px)';
  toast.style.opacity = '0';

  // Иконки и цвета для разных типов
  let iconHTML = '';
  let bgColor = '';
  switch (type) {
    case 'success':
      bgColor = 'linear-gradient(135deg, #00b09b, #96c93d)';
      iconHTML = '<i class="fas fa-check-circle" style="margin-right:10px; font-size:1.4em; color:#fff;"></i>';
      break;
    case 'error':
      bgColor = 'linear-gradient(135deg, #f85032, #e73827)';
      iconHTML = '<i class="fas fa-exclamation-triangle" style="margin-right:10px; font-size:1.4em; color:#fff;"></i>';
      break;
    case 'info':
    default:
      bgColor = 'linear-gradient(135deg, #36d1dc, #5b86b5)';
      iconHTML = '<i class="fas fa-info-circle" style="margin-right:10px; font-size:1.4em; color:#fff;"></i>';
      break;
  }

  toast.style.background = bgColor;

  toast.innerHTML = `
    <div style="display:flex; align-items:center;">
      ${iconHTML}
      <div style="flex:1;">${message}</div>
    </div>
    <button style="
      margin-left:15px;
      background: transparent;
      border: none;
      color: #fff;
      font-size:1.6em;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
    " aria-label="Закрыть" onmouseover="this.style.color='#ff0'" onmouseout="this.style.color='#fff'" onclick="this.parentElement.style.opacity='0'; this.parentElement.style.transform='translateY(-20px)'; setTimeout(() => { if (this.parentElement.parentNode) this.parentElement.parentNode.removeChild(this.parentElement); }, 400);">&times;</button>
  `;

  container.appendChild(toast);

  // Анимация появления
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(-20px)';
    toast.style.boxShadow = '0 12px 24px rgba(0,0,0,0.4)';
  }, 10);

  // Автоматическое исчезновение
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px)';
    toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    setTimeout(() => {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 400);
  }, 5000);
}
document.getElementById('prevGraph').addEventListener('click', () => {
  if (csvFilesData.length <= 1) return;
  currentCsvIndex = (currentCsvIndex - 1 + csvFilesData.length) % csvFilesData.length;
  processCSV(csvFilesData[currentCsvIndex]);
  updateChart();
  renderFileNames(); // Обновляем подсветку имени файла
  showToast(`График ${currentCsvIndex + 1} из ${csvFilesData.length}`, 'info');
});

document.getElementById('nextGraph').addEventListener('click', () => {
  if (csvFilesData.length <= 1) return;
  currentCsvIndex = (currentCsvIndex + 1) % csvFilesData.length;
  processCSV(csvFilesData[currentCsvIndex]);
  updateChart();
  renderFileNames(); // Обновляем подсветку имени файла
  showToast(`График ${currentCsvIndex + 1} из ${csvFilesData.length}`, 'info');
});
function updateGraphSwitchButtons() {
  document.getElementById('prevGraph').disabled = csvFilesData.length <= 1;
  document.getElementById('nextGraph').disabled = csvFilesData.length <= 1;
}
function renderFileNames() {
  const container = document.getElementById('fileNamesContainer');
  container.innerHTML = '';

  fileNames.forEach((name, index) => {
    const span = document.createElement('span');
    span.textContent = name;
    span.style.cursor = 'pointer';
    span.style.padding = '6px 12px';
    span.style.borderRadius = '8px';
    span.style.backgroundColor = index === currentCsvIndex ? 'rgba(102, 126, 234, 0.3)' : 'transparent';
    span.style.border = '1px solid #ccc';

    span.onclick = () => {
      if (index !== currentCsvIndex) {
        currentCsvIndex = index;
        processCSV(csvFilesData[currentCsvIndex]);
        updateChart();
        renderFileNames(); // Обновим выделение
      }
    };

    container.appendChild(span);
  });
}
document.getElementById('compareGraphsBtn').addEventListener('click', showComparisonChart);
function showComparisonChart() {
  if (!dataBlocks || !dataBlocksSecond) {
    showToast('Загрузите оба файла для сравнения', 'info');
    return;
  }

  const ctx = document.getElementById('myChart').getContext('2d');

  // Предположим, что выбран один блок, инструмент и режим
  const blockName = currentBlock;
  const tool = document.getElementById('toolSelect').value;
  const mode = document.getElementById('modeSelect').value;

  const block1 = dataBlocks[blockName];
  const block2 = dataBlocksSecond[blockName];

  if (!block1 || !block2) {
    showToast('Недостаточно данных для сравнения', 'error');
    return;
  }

  const labels = block1.labels; // Предположим, что они совпадают
  if (!labels || labels.length === 0) {
    showToast('Нет данных для отображения', 'error');
    return;
  }

  // Собираем данные по выбранному инструмент и режиму
  const datasets = [];

  if (mode === 'all') {
    const persons = Object.keys(block1.data[tool] || {});
    persons.forEach((person, index) => {
      const data1 = block1.data[tool][person] || Array(labels.length).fill(0);
      const data2 = block2.data[tool][person] || Array(labels.length).fill(0);
      datasets.push({
        label: `${person} (файл 1)`,
        data: data1,
        borderColor: getColor(index),
        backgroundColor: getColor(index, 0.2),
        fill: false,
        tension: 0.3
      });
      datasets.push({
        label: `${person} (файл 2)`,
        data: data2,
        borderColor: getColor(index, 0.7),
        backgroundColor: getColor(index, 0.4),
        fill: false,
        borderDash: [5, 5],
        tension: 0.3
      });
    });
  } else {
    const employee = document.getElementById('employeeSelect').value;
    if (employee && block1.data[tool][employee] && block2.data[tool][employee]) {
      datasets.push({
        label: `${employee} (файл 1)`,
        data: block1.data[tool][employee],
        borderColor: getColor(0),
        fill: false
      });
      datasets.push({
        label: `${employee} (файл 2)`,
        data: block2.data[tool][employee],
        borderColor: getColor(1),
        borderDash: [5, 5],
        fill: false
      });
    } else {
      showToast('Нет данных для выбранного сотрудника', 'error');
      return;
    }
  }

  // Создаем новый график или обновляем существующий
  if (chartInstance) {
    chartInstance.destroy();
  }

  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { color: getChartTextColor() } },
        title: { display: true, text: 'Сравнение файлов', color: getChartTextColor() }
      },
      scales: {
        x: { ticks: { color: getChartTextColor() } },
        y: { ticks: { color: getChartTextColor() } }
      }
    }
  });
}
function startSnow() {
  if (snowActive) return;
  snowActive = true;
  showToast('Зима в разгаре!', 'info');
  snowContainer = document.createElement('div');
  snowContainer.className = 'snow';
  document.body.appendChild(snowContainer);

  // Создаем 15 снежинок каждые 200ms
  snowInterval = setInterval(() => {
    for (let i = 0; i < 5; i++) {
      const snowflake = document.createElement('div');
      const size = Math.random() * 6 + 2; // размер от 2px до 6px
      
      // Определяем цвет снежинки в зависимости от темы
      const isDark = document.body.classList.contains('dark');
      const snowColor = isDark ? '#fff' : '#ace5ee'; // белый или голубой
      
      snowflake.style.backgroundColor = snowColor;
      snowflake.style.width = `${size}px`;
      snowflake.style.height = `${size}px`;
      snowflake.style.left = `${Math.random() * 100}%`;
      snowflake.style.opacity = Math.random();

      // Продолжительность падения
      const fallDuration = 8000 + Math.random() * 7000;
      const driftX = Math.random() * 100 - 50;

      snowflake.animate([
        { transform: `translateY(-10px) translateX(0)` },
        { transform: `translateY(${window.innerHeight + 20}px) translateX(${driftX}px)` }
      ], {
        duration: fallDuration,
        iterations: 1,
        easing: 'linear'
      }).onfinish = () => {
        if (snowflake.parentNode) snowflake.parentNode.removeChild(snowflake);
      };
      
      snowContainer.appendChild(snowflake);
    }
  }, 400);
}

function stopSnow() {
  if (!snowActive) return;
  snowActive = false;
  showToast('Снег остановлен', 'info');
  clearInterval(snowInterval);
  if (snowContainer) {
    document.body.removeChild(snowContainer);
    snowContainer = null;
  }
}
document.getElementById('snowToggleBtn').addEventListener('click', () => {
  if (snowActive) {
    stopSnow();
    document.getElementById('snowToggleBtn').innerHTML = '<i class="fas fa-snowflake"></i>';
    document.getElementById('snowToggleBtn').title = 'Запустить снег';
  } else {
    startSnow();
    document.getElementById('snowToggleBtn').innerHTML = '<i class="fas fa-snowflake"></i>';
    document.getElementById('snowToggleBtn').title = 'Остановить снег';
  }
});
function isSnowPeriod() {
  const now = new Date();
  const year = now.getFullYear();

  const start = new Date(year, 11, 1); // 1 декабря текущего года
  const end = new Date(year + (now < new Date(year, 2, 1) ? 1 : 0), 2, 28, 23, 59, 59); // 28 февраля следующего года, если сейчас после марта
  // Для корректности, лучше сделать так:
  const startDate = new Date(year, 11, 1); // 1 декабря
  const endDate = new Date(year + (now.getMonth() >= 11 ? 1 : 0), 2, 28, 23, 59, 59);

  return now >= startDate && now <= endDate;
}
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});
document.addEventListener('DOMContentLoaded', function() {
  // Анимация при загрузке страницы
  document.body.style.opacity = '0';
  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 50);
});
  (function(){
  const secret = 'hello';
  let buf = '';

  window.addEventListener('keydown', (e) => {
    if (e.key.length === 1 && /[a-z]/i.test(e.key)) {
      buf += e.key.toLowerCase();
      if (buf.endsWith(secret)) {
        showHelloEaster();
        buf = '';
      }
      // хранить только последние N символов
      if (buf.length > secret.length) buf = buf.slice(-secret.length);
    } else {
      // не буквы — обнулять прогресс
      buf = '';
    }
  });
  function showHelloEaster() {
    showToast('Привет! Это же надо было додуматься', 'success');
    // пример: плавный переход цвета графика или мини-анимация
    document.body.style.transition = 'background 2.5s';
    document.body.style.background = "url('https://i.ytimg.com/vi/Q-hVSrthyVY/oar2.jpg?sqp=-oaymwEYCKoFENAFSFqQAgHyq4qpAwcIARUAAIhC&rs=AOn4CLA1ojBwnxvV35DtxAIV-R82z-9bhA') no-repeat center/cover";
    setTimeout(() => document.body.style.background = '', 800);
  }
})();
(function(){
  const el = document.getElementById('footer') || document.body;
  let clicks = 0;
  let timer = null;

  el.addEventListener('click', () => {
    clicks++;
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => { clicks = 0; }, 500);

    if (clicks >= 3) {
      clicks = 0;
      showEaster();
    }
  });

  function showEaster() {
    showToast('Три клика — тебе что делать нечего?', 'success');
    startConfetti();
  }
})();
  function startConfetti() {
  for (let i=0; i<250; i++) {
    const confetti = document.createElement('div');
    confetti.style.position = 'fixed';
    confetti.style.top = Math.random() * window.innerHeight + 'px';
    confetti.style.left = Math.random() * window.innerWidth + 'px';
    confetti.style.width = confetti.style.height = '4px';
    confetti.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 60%)`;
    confetti.style.borderRadius = '50%';
    confetti.style.zIndex = '9999';
    document.body.appendChild(confetti);
    confetti.animate([
      { transform: `translateY(0)`, opacity: 1 },
      { transform: `translateY(${window.innerHeight + 10}px)`, opacity: 0 }
    ], {
      duration: 6000 + Math.random()*2000,
      easing: 'ease-out'
    }).onfinish = () => {
      confetti.remove();
    };
  }
}
window.addEventListener('keydown', (e) => {
  if (e.key === 'p') {
    showPingwinAnimation();
  }
});

function showPingwinAnimation() {
  showToast('🐧 Пингвин активирован!', 'success');
  // Можете добавить анимацию или изображение пингвина
  const penguin = document.createElement('img');
  penguin.src = 'https://media.tenor.com/sufc4L0B_hgAAAAM/penguin-slap.gif'; // или ваше изображение
  penguin.style.position = 'fixed';
  penguin.style.bottom = '300px';
  penguin.style.right = '300px';
  penguin.style.width = '150px';
  penguin.style.zIndex = '10000';
  document.body.appendChild(penguin);
  setTimeout(() => {
    if (penguin.parentNode) penguin.remove();
  }, 3000);
}
  
const hiddenBtn = document.createElement('button');
hiddenBtn.style.position = 'fixed';
hiddenBtn.style.top = '150px';
hiddenBtn.style.left = '5%';
hiddenBtn.style.transform = 'translateX(-50%)';
hiddenBtn.style.width = '120px';
hiddenBtn.style.height = '50px';
hiddenBtn.style.opacity = '0';
hiddenBtn.style.border = 'none';
hiddenBtn.style.background = '#ff6f61';
hiddenBtn.style.color = '#fff';
hiddenBtn.style.fontSize = '14px';
hiddenBtn.style.borderRadius = '25px';
hiddenBtn.style.cursor = 'pointer';
hiddenBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
hiddenBtn.title = 'Запустить сложный новогодний квест';
document.body.appendChild(hiddenBtn);

hiddenBtn.onclick = () => {
  // Удаляем предыдущие элементы
  document.querySelectorAll('.game-container').forEach(el => el.remove());

  const steps = [
  {
    description: 'Расшифруйте шифр: "19 15 6 4 21 18 16 25 12 1". (подсказка: Каждая цифра — это буква. Найди их в алфавите!)',
    type: 'cipher',
    answer: 'снегурочка',
  },
  {
    description: 'Ответьте на вопрос: "Какая дата считается официальным началом Нового года в России?"',
    type: 'code',
    answer: '1 января',
  },
  {
    description: 'Выберите правильный ответ: "Что традиционно ставят под елку?"',
    type: 'multipleChoice',
    options: ['Подарки', 'Бананы', 'Камни', 'Цветы'],
    answer: 'Подарки',
  },
  {
    description: 'Назовите три символа Нового года.',
    type: 'textAnswer',
    answer: ['ёлка', 'шары', 'Дед Мороз'],
  },
  {
    description: 'Как называется традиционный напиток, часто пьют на Новый год в России?',
    type: 'searchWord',
    answer: 'шампанское',
  },
  {
    description: 'Что обычно делают на новогоднем столе? (выберите один правильный ответ)',
    type: 'multipleChoice',
    options: ['Пицца', 'Оливье', 'Бургер', 'Рыба'],
    answer: 'Оливье',
  },
  {
    description: 'Как называется популярный новогодний персонаж, который приносит подарки?',
    type: 'searchWord',
    answer: 'Дед Мороз',
  },
  {
    description: 'Назовите два зимних природных явления, связанных с Новым годом.',
    type: 'textAnswer',
    answer: ['снег', 'мороз'],
  },
 {
    description: 'Назовите две традиционные новогодние игры или конкурсы, популярные в России.',
    type: 'textAnswer',
    answer: ['передача подарков', 'игра в снежки'],
  },
  {
    description: 'Какая известная песня исполняется в каждом доме в новогоднюю ночь в России?',
    type: 'searchWord',
    answer: 'В лесу родилась елочка',
  },
  {
    description: 'Назовите три зимних природных явления, связанных с Новым годом.',
    type: 'textAnswer',
    answer: ['снег', 'мороз', 'лед'],
  }
];

  let currentStepIndex = 0;

  // Создаем фоновый эффект
  const bg = document.createElement('div');
  bg.className = 'game-container';
  bg.style.position = 'fixed';
  bg.style.top = '0';
  bg.style.left = '0';
  bg.style.width = '100%';
  bg.style.height = '100%';
  bg.style.backgroundImage = 'var(--bg-color)';
  bg.style.backgroundSize = 'cover';
  bg.style.display = 'flex';
  bg.style.justifyContent = 'center';
  bg.style.alignItems = 'center';
  bg.style.zIndex = '9999';
  bg.style.backdropFilter = 'blur(4px)';
  document.body.appendChild(bg);

  // Создаем окно с вопросом
  const windowEl = document.createElement('div');
  windowEl.style.backgroundColor = 'var(--hover-bg-color)';
  windowEl.style.borderRadius = '20px';
  windowEl.style.padding = '30px';
  windowEl.style.maxWidth = '700px';
  windowEl.style.width = '90%';
  windowEl.style.boxShadow = '0 8px 20px rgba(0,0,0,0.3)';
  windowEl.style.position = 'relative';
  windowEl.className = 'game-window';

  bg.appendChild(windowEl);

  // Заголовок
  const title = document.createElement('h2');
  title.innerHTML = '🎄 <span style="color:#d6336c;">Новогодний Квест</span> 🎄';
  title.style.textAlign = 'center';
  title.style.marginBottom = '20px';
  title.style.fontFamily = 'Arial, sans-serif';
  title.style.fontSize = '24px';
  windowEl.appendChild(title);

  // Описание вопроса
  const descriptionEl = document.createElement('p');
  descriptionEl.style.fontSize = '18px';
  descriptionEl.style.fontFamily = 'Arial, sans-serif';
  descriptionEl.style.color = 'var(--text-color)';
  descriptionEl.style.marginBottom = '20px';
  windowEl.appendChild(descriptionEl);

  // Ввод
  const input = document.createElement('input');
  input.type = 'text';
  input.style.width = '100%';
  input.style.padding = '15px';
  input.style.fontSize = '16px';
  input.style.borderRadius = '10px';
  input.style.border = '2px solid #ccc';
  input.style.outline = 'none';
  input.style.transition = 'border-color 0.3s';
  windowEl.appendChild(input);

  // Кнопка
  const btn = document.createElement('button');
  btn.innerText = 'Проверить';
  btn.style.marginTop = '20px';
  btn.style.padding = '15px 30px';
  btn.style.fontSize = '16px';
  btn.style.border = 'none';
  btn.style.borderRadius = '10px';
  btn.style.backgroundColor = '#28a745';
  btn.style.color = '#fff';
  btn.style.cursor = 'pointer';
  btn.style.transition = 'background-color 0.3s';
  btn.onmouseover = () => { btn.style.backgroundColor = '#218838'; };
  btn.onmouseout = () => { btn.style.backgroundColor = '#28a745'; };
  windowEl.appendChild(btn);

  // Сообщение
  const message = document.createElement('div');
  message.style.marginTop = '15px';
  message.style.fontSize = '16px';
  message.style.color = '#555';
  message.style.minHeight = '20px';
  windowEl.appendChild(message);

  function updateStep() {
    const step = steps[currentStepIndex];
    descriptionEl.innerHTML = step.type === 'multipleChoice' ? step.description : step.description;
    input.value = '';
    message.innerText = '';

    if (step.type === 'multipleChoice') {
      // Создаем варианты
      createOptions(step.options);
    } else {
      // Удаляем все варианты, если есть
      removeOptions();
    }
  }

  function createOptions(options) {
    // Удаляем старые опции
    removeOptions();
    const optionsContainer = document.createElement('div');
    optionsContainer.id = 'optionsContainer';
    options.forEach(opt => {
      const btnOption = document.createElement('button');
      btnOption.innerText = opt;
      btnOption.style.display = 'block';
      btnOption.style.width = '100%';
      btnOption.style.marginTop = '10px';
      btnOption.style.padding = '12px';
      btnOption.style.border = 'none';
      btnOption.style.borderRadius = '8px';
      btnOption.style.backgroundColor = '#007bff';
      btnOption.style.color = '#fff';
      btnOption.style.cursor = 'pointer';
      btnOption.style.transition = 'background-color 0.3s';
      btnOption.onmouseover = () => { btnOption.style.backgroundColor = '#0069d9'; };
      btnOption.onmouseout = () => { btnOption.style.backgroundColor = '#007bff'; };
      btnOption.onclick = () => {
        checkMultipleChoice(opt);
      };
      optionsContainer.appendChild(btnOption);
    });
    windowEl.appendChild(optionsContainer);
  }

  function removeOptions() {
    const oldOptions = document.getElementById('optionsContainer');
    if (oldOptions) oldOptions.remove();
  }

  function checkMultipleChoice(selectedOption) {
    const step = steps[currentStepIndex];
    if (selectedOption.toLowerCase() === step.answer.toLowerCase()) {
      message.innerText = '✅ Правильно!';
      proceedNext();
    } else {
      message.innerText = '❌ Неправильно, попробуйте снова.';
    }
  }

  function proceedNext() {
    currentStepIndex++;
    if (currentStepIndex >= steps.length) {
      showFinalPrize();
    } else {
      setTimeout(() => {
        updateStep();
      }, 1000);
    }
  }

  function checkAnswer() {
    const step = steps[currentStepIndex];

    if (step.type === 'searchWord' || step.type === 'cipher' || step.type === 'code' || step.type === 'textAnswer') {
      const userAnswer = input.value.trim().toLowerCase();

      if (step.type === 'textAnswer') {
        // Можно проверить, есть ли ответ в массиве
        const answers = step.answer;
        const match = answers.some(a => userAnswer.includes(a.toLowerCase()));
        if (match) {
          message.innerText = '✅ Правильно!';
          proceedNext();
        } else {
          message.innerText = '❌ Неправильно, попробуйте еще раз.';
        }
      } else {
        if (userAnswer === step.answer.toLowerCase()) {
          message.innerText = '✅ Правильно!';
          proceedNext();
        } else {
          message.innerText = '❌ Неправильно, попробуйте еще раз.';
        }
      }
    }
  }

  btn.onclick = checkAnswer;
  input.focus();
  updateStep();

  function showFinalPrize() {
    bg.remove();

    // Поздравление
    const finalMsg = document.createElement('div');
finalMsg.innerHTML = `<h2 style="text-align:center; color:#d6336c;">🎉 Поздравляем! Вы прошли квест! 🎉</h2>`;
finalMsg.style.position = 'fixed';
finalMsg.style.top = '50%';
finalMsg.style.left = '50%';
finalMsg.style.transform = 'translate(-50%, -50%)';
finalMsg.style.backgroundColor = 'rgba(255,255,255,0.95)';
finalMsg.style.padding = '40px';
finalMsg.style.borderRadius = '20px';
finalMsg.style.boxShadow = '0 8px 20px rgba(0,0,0,0.3)';
finalMsg.style.zIndex = '999999';
finalMsg.style.transition = 'opacity 0.6s ease';
finalMsg.style.opacity = '1';
document.body.appendChild(finalMsg);

// Через 5 секунд плавно исчезнуть и удалить
setTimeout(() => {
  finalMsg.style.opacity = '0';
  setTimeout(() => finalMsg.remove(), 600); // ждем завершения анимации
}, 5000)}
  // Изначально
  updateStep();
};
// Обработчик для кнопки "Статус"
document.getElementById('chckst').addEventListener('click', () => {
  document.getElementById('bugIdModal').style.display = 'flex';
  document.getElementById('bugModal').classList.remove('show');
  showLastBugIds();
});
// Обработчик для закрытия окна поиска Bug ID
document.getElementById('closeBugIdModal').addEventListener('click', () => {
  document.getElementById('bugIdModal').style.display = 'none';
});
// Обработчик поиска Bug ID
document.getElementById('searchBugId').addEventListener('click', () => {
  const bugId = document.getElementById('bugIdInput').value.trim();
  if (!bugId) {
    showToast('Пожалуйста, введите Bug ID.', 'info');
    return;
  }
  fetchBugStatus(bugId);
});
function fetchBugStatus(bugId) {
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/1IGnuwozgAb-cwD-pr7aeMHTX80J06mV8F0IJ9KLmTSk/gviz/tq?sheet=Лист2';

  fetch(sheetUrl)
    .then(res => res.text())
    .then(text => {
      const jsonText = text.substring(47).slice(0, -2);
      const jsonData = JSON.parse(jsonText);
      const rows = jsonData.table.rows;
      
      let found = false;
      let status = '';
      
      for (const row of rows) {
        const cols = row.c;
        if (cols && cols.length >= 5) {
          const currentBugId = cols[4].v.trim(); // колонка 4 — Bug ID
          if (currentBugId === bugId) {
            // колонка 2 — статус
            status = cols[2] ? cols[2].v : 'Нет статуса';
            found = true;
            break;
          }
        }
      }
      const resultDiv = document.getElementById('bugStatusResult');
      if (found) {
        // Иконка успеха + статус
        resultDiv.innerHTML = `
          <div style="
            padding: 10px 15px;
            background-color: var(--hover-bg-color);
            border: 2px solid #4dd0e1;
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          ">
            <i class="fas fa-check-circle" style="margin-right:8px; color:#28a745;"></i>
            <strong>Статус для Bug ID ${bugId}:</strong> <em>${status}</em>
          </div>`;
      } else {
        // Иконка ошибки/не найдено
        resultDiv.innerHTML = `
          <div style="
            padding: 10px 15px;
            background-color: var(--hover-bg-color);
            border: 2px solid #e57373;
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          ">
            <i class="fas fa-times-circle" style="margin-right:8px; color:#c62828;"></i>
            <strong>Bug ID ${bugId} не найден.</strong>
          </div>`;
}
    })
    .catch(() => {
      showToast('Ошибка при получении данных.', 'error');
    });
}
function showLastBugIds() {
  const recentBugs = bugIdHistory.slice(0, 5);
  const html = recentBugs.map(entry => {
    const dateStr = entry.timestamp.toLocaleString(); // формат даты и времени
    return `<div style="margin-bottom:8px;">Bug ID: ${entry.id} <br/><small>${dateStr}</small></div>`;
  }).join('');
  // вставляем в блок
  document.getElementById('recentBugIds').innerHTML = `<h4>Последние 5 Bug ID:</h4>${html}`;
}
const bugIdInput = document.getElementById('bugIdInput');
if (bugIdInput) {
  bugIdInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      // запускаем поиск
      const searchBtn = document.getElementById('searchBugId');
      if (searchBtn) searchBtn.click();
    }
  });
}
document.getElementById('instructionToggle')
        .addEventListener('click', () => {
  document.getElementById('instructionModal').style.display = 'flex';
});
document.getElementById('backHomeBtn')
        .addEventListener('click', () => {
  window.open('index.html', '_self');
});
// ===== Переключение интерфейсов =====
document.getElementById('toggleInterfaceBtn').addEventListener('click', toggleInterface);

function toggleInterface() {
  const currentPage = window.location.pathname;
  
  if (currentPage.includes('graph.html') || currentPage.includes('index.html')) {
    // Если мы на старом интерфейсе, переключаемся на новый
    localStorage.setItem('preferredInterface', 'new');
    window.open('new-interface.html', '_self');
  } else if (currentPage.includes('new-interface.html')) {
    // Если мы на новом интерфейсе, переключаемся на старый
    localStorage.setItem('preferredInterface', 'old');
    window.open('graph.html', '_self');
  }
  
  showToast('Интерфейс переключен', 'success');
}

// При загрузке страницы проверяем предпочтения
window.addEventListener('load', () => {
  const preferredInterface = localStorage.getItem('preferredInterface');
  const currentPage = window.location.pathname;
  
  // Можно добавить автоматическое перенаправление при первом посещении
  if (!preferredInterface && !currentPage.includes('new-interface')) {
    // По умолчанию используем новый интерфейс
    localStorage.setItem('preferredInterface', 'new');
  }
});
</script>
</body>
</html>
