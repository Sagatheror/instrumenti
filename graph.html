–ü–æ–ø—Ä–∞–≤—å –≤ —ç—Ç–æ–º –∫–æ–¥–µ
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- –°—Ç–∏–ª—å -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

/* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
:root {
  --font-family: 'Inter', sans-serif;
  --border-radius: 16px;
  --shadow: rgba(0, 0, 0, 0.2);
  --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
  --accent-gradient: linear-gradient(135deg, #89f7fe, #66a6ff);
  --background-gradient: linear-gradient(135deg, #f0f2f5, #d9e2ef);
  --text-color: #222;
  --bg-color: #fff;
  --border-color: #ddd;
  --hover-bg-color: #f9f9f9;
  --label-color: #222;
  --chart-bg-color: #fafafa;
  --button-bg: linear-gradient(135deg, #667eea, #764ba2);
  --button-hover-bg: linear-gradient(135deg, #5a9, #4a8);
  --result-bg: linear-gradient(135deg, #e0f7fa, #b2ebf2);
  --chart-text-color: #222;
  --font-size-base: 16px;
  --changelog-header-color: #2c3e50; /* —Ü–≤–µ—Ç –≤–µ—Ä—Å–∏–∏ */
  --changelog-date-color: #7f8c8d;   /* —Ü–≤–µ—Ç –¥–∞—Ç—ã */
  --changelog-type-bg: #3498db;      /* —Ñ–æ–Ω —Ç–∏–ø–∞ */
  --changelog-entry-bg: #f9f9f9;     /* —Ñ–æ–Ω –∑–∞–ø–∏—Å–∏ */
  --changelog-entry-text: #333;      /* —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏ */
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
body.dark {
  --text-color: #eee;
  --bg-color: #2b2b2b;
  --border-color: #555;
  --hover-bg-color: #444;
  --label-color: #ddd;
  --chart-bg-color: #3a3a3a;
  --button-bg: linear-gradient(135deg, #444, #222);
  --result-bg: linear-gradient(135deg, #555, #333);
  --chart-text-color: #eee;
  --changelog-version-color: #2c3e50;
  --changelog-date-color: #7f8c8d;
  --changelog-type-bg: #3498db;
  --changelog-entry-bg: #f9f9f9;
  --changelog-entry-color: #333;
}
body.dark-theme {
  --changelog-version-color: #ecf0f1;
  --changelog-date-color: #bdc3c7;
  --changelog-type-background: #2980b9;
  --changelog-entry-background: #444;
  --changelog-entry-color: #eee;
}
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
body {
  margin: 0;
  font-family: var(--font-family);
  background: var(--background-gradient);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}

/* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã */
.theme-switch {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  padding: 12px 20px;
  border-radius: calc(var(--border-radius) * 1.2);
  cursor: pointer;
  font-size: 1.4em;
  font-weight: 600;
  color: #fff;
  box-shadow: 0 4px 15px var(--shadow);
  transition: all 0.3s ease;
}
body.dark .theme-switch {
  background: linear-gradient(135deg, #444, #222);
}
.theme-switch:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.container {
  max-width: 1300px;
  margin: 50px auto;
  padding: 30px;
  background: var(--bg-color);
  border-radius: calc(var(--border-radius));
  box-shadow: 0 16px 40px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 40px;
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
.top-panel {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ + –∫–Ω–æ–ø–∫–∞ */
.file-zone {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.file-label {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 15px 25px;
  border-radius: calc(var(--border-radius));
  cursor: pointer;
  font-size: 1.3em;
  font-weight: 600;
  box-shadow: 0 4px 14px var(--shadow);
  transition: all 0.2s ease;
}
.file-label:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}
#csvFileInput {
  display: none;
}
#exportSOTBtn {
  margin-top: 12px;
  padding: 15px 25px;
  font-size: 1.3em;
  border: none;
  border-radius: calc(var(--border-radius));
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 14px var(--shadow);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
}
#exportSOTBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
.settings {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  flex: 1;
}
.setting-box {
  background: var(--hover-bg-color);
  padding: 20px;
  border-radius: calc(var(--border-radius));
  box-shadow: 0 4px 14px var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 220px;
  transition: all 0.2s ease;
}
.setting-box:hover {
  box-shadow: 0 6px 20px var(--shadow);
}
.setting-box label {
  font-weight: 600;
  margin-bottom: 10px;
  font-size: 1.2em;
  color: var(--label-color);
  display: flex;
  align-items: center;
  gap: 8px;
}
.setting-box select {
  padding: 14px 20px;
  border-radius: calc(var(--border-radius));
  border: none;
  background: #fff;
  font-size: 1.2em;
  min-width: 150px;
  box-shadow: 0 2px 8px var(--shadow);
  cursor: pointer;
  transition: all 0.2s ease;
}
.setting-box select:hover {
  box-shadow: 0 4px 12px var(--shadow);
  outline: none;
}

/* –ì—Ä–∞—Ñ–∏–∫ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã */
.chart-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  width: 100%;
}
#chartTitle {
  font-size: 2em;
  font-weight: 700;
  margin-bottom: 15px;
  color: var(--label-color);
  text-align: center;
}
#chartContainer {
  height: 500px;
  width: 100%;
  background: var(--chart-bg-color);
  padding: 20px;
  border-radius: calc(var(--border-radius));
  box-shadow: inset 0 8px 16px rgba(0,0,0,0.05);
  transition: background 0.3s;
}
.buttons {
  display: flex;
  gap: 15px;
  margin-top: 15px;
}
.btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 12px 24px;
  font-size: 1.2em;
  border: none;
  border-radius: calc(var(--border-radius));
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* –ò—Ç–æ–≥–æ–≤–∞—è –∑–æ–Ω–∞ */
#averageResult {
  margin-top: 40px;
  padding: 30px;
  background: var(--result-bg);
  border-radius: calc(var(--border-radius));
  font-size: 1.8em;
  font-weight: 600;
  color: var(--label-color);
  max-width: 800px;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
  text-align: center;
  box-shadow: 0 4px 14px rgba(0,0,0,0.05);
}
#averageResult:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
#sotModal {
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.5);
  justify-content: center; 
  align-items: center; 
  z-index: 9999;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
}
#sotModal.show {
  display: flex;
  opacity: 1;
}
#sotModal > div {
  background: #fff; 
  padding: 20px;
  max-width: 90%;
  width: 80%;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#sotIframe {
  width: 100%; 
  height: 70vh; 
  border: none; 
  border-radius: 10px;
}
#closeSOTModal {
  align-self: center;
  padding: 10px 20px;
  font-size: 1.2em;
  border: none;
  border-radius: calc(var(--border-radius));
  background: #555;
  color: #fff;
  cursor: pointer;
  transition: background 0.2s;
}
#closeSOTModal:hover {
  background: #333;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∏ */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.changelog-version {
  font-weight: 600;
  font-size: 15px;
  color: var(--changelog-header-color);
}
.changelog-date {
  font-size: 13px;
  color: var(--changelog-date-color);
}
.changelog-type {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: #fff;
  background-color: var(--changelog-type-bg);
}

/* –§–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏ */
.changelog-entry {
  margin-bottom: 10px;
  padding: 12px 15px;
  background-color: var(--changelog-entry-bg);
  border-radius: 8px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  transition: background 0.2s, transform 0.2s;
}
/* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å–ª–µ–≤–∞ —Å –∫—Ä–∞—Å–∏–≤—ã–º —Å—Ç–∏–ª–µ–º */
#changelogContainer {
  display: none; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
  position: fixed; top: 70px; left: 20px; /* —Å–ª–µ–≤–∞ */
  width: 420px;
  max-height: 500px;
  overflow-y: auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  z-index: 9999;
  font-family: 'Montserrat', sans-serif;
  font-size: 14px;
  color: #333;
  transition: opacity 0.3s, transform 0.3s;
}
#changelogContainer.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}
#changelogContainer h4 {
  margin-top: 0;
  font-size: 18px;
  margin-bottom: 15px;
  font-weight: 600;
  border-bottom: 2px solid #ddd;
  padding-bottom: 8px;
  color: #222;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ */
.changelog-entry {
  margin-bottom: 10px;
  padding: 12px 15px;
  background-color: #f9f9f9;
  border-radius: 8px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  transition: background 0.2s, transform 0.2s;
}
.changelog-entry:hover {
  background-color: #f1f1f1;
  transform: translateY(-2px);
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø–∏—Å–∏ */
.changelog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.changelog-version {
  font-weight: 600;
  font-size: 15px;
  color: #2c3e50;
}
.changelog-date {
  font-size: 13px;
  color: #7f8c8d;
}
.changelog-type {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: #fff;
  background-color: #3498db;
}
/* –¶–≤–µ—Ç –¥–ª—è —Ç–∏–ø–æ–≤ */
.changelog-type.–î–æ–±–∞–≤–ª–µ–Ω–æ { background-color: #27ae60; }
.changelog-type.–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ { background-color: #f39c12; }
.changelog-type.–û–±—â–µ–µ { background-color: #8e44ad; }
</style>
</head>
<body>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
<button class="theme-switch" id="themeToggle"><i class="fas fa-moon"></i></button>

<div class="container">
<!-- –ë–ª–æ–∫ changelog -->
<div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
  <button id="changelogToggle" style="padding:15px 20px; border:none; border-radius:8px; background:var(--primary-gradient); color:#fff; cursor:pointer; font-weight:600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: background 0.3s;">
    Changelog
  </button>
</div>
<div id="changelogContainer">
  <h4 style="margin-top:0;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h4>
  <textarea id="changelogText" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π..."></textarea>
  <button id="saveChangelog"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="top-panel">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="file-zone">
      <label class="file-label" id="exportSOTBtn">
        <i class="fas fa-file-export"></i> –í—ã–≥—Ä—É–∑–∏—Ç—å –°–û–¢
      </label>
      <label class="file-label" for="csvFileInput">
        <i class="fas fa-upload"></i> –í—ã–±–µ—Ä–∏—Ç–µ CSV
      </label>
      <input type="file" id="csvFileInput" accept=".csv" />
    </div>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="settings">
      <div class="setting-box">
        <label for="blockSelect"><i class="fas fa-puzzle-piece"></i> –ë–ª–æ–∫</label>
        <select id="blockSelect"></select>
      </div>
      <div class="setting-box">
        <label for="toolSelect"><i class="fas fa-wrench"></i> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
        <select id="toolSelect"></select>
      </div>
      <div class="setting-box">
        <label for="modeSelect"><i class="fas fa-cog"></i> –†–µ–∂–∏–º</label>
        <select id="modeSelect">
          <option value="all">–û–±—â–∏–π</option>
          <option value="individual">–ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</option>
        </select>
      </div>
      <div class="setting-box" id="employeeBox" style="display:none;">
        <label for="employeeSelect"><i class="fas fa-user"></i> –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select id="employeeSelect"></select>
      </div>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫ –∏ –∏—Ç–æ–≥ -->
  <div class="chart-section">
    <div id="chartTitle"><i class="fas fa-search"></i> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
    <div id="chartContainer">
      <canvas id="myChart"></canvas>
    </div>
    <div class="buttons">
      <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn" id="topBtn"><i class="fas fa-star"></i> –¢–û–ü</button>
    </div>
    <div id="averageResult"></div>
  </div>

</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="sotModal">
  <div>
    <iframe id="sotIframe" src="https://s-o-t.ru/netcat/?catalogue=1&sub=1891833"></iframe>
    <button class="btn" id="closeSOTModal"><i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
let dataBlocks = {
    SOT: { labels: [], data: {} },
    PMK: { labels: [], data: {} },
    TORUDA: { labels: [], data: {} }
};
let currentBlock = null;
let currentTool = null;
let currentEmployee = null;
let chartInstance = null;
let currentLabels = [];
let currentDatasets = [];

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
const themeBtn = document.getElementById('themeToggle');
let darkMode = false;
themeBtn.onclick = () => {
  darkMode = !darkMode;
  document.body.classList.toggle('dark');
  document.body.classList.toggle('dark-theme', themeToggle.checked);
  themeBtn.innerHTML = darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

  // –ú–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é --background-gradient
  if (darkMode) {
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #111, #222)'
    );
  } else {
    document.documentElement.style.setProperty(
      '--background-gradient',
      'linear-gradient(135deg, #f0f2f5, #d9e2ef)'
    );
  }

  updateChart();
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞
document.getElementById('csvFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    processCSV(e.target.result);
    document.getElementById('chartTitle').innerHTML = '<i class="fas fa-check-circle"></i> –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã';
    document.getElementById('averageResult').innerHTML = '';
    document.getElementById('modeSelect').value = 'all';
    toggleEmployeeSelection();
    updateChart();
  };
  reader.readAsText(file);
});

// –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
function parseDate(str) {
  const parts = str.trim().split('.');
  if (parts.length !== 3) return null;
  let [d, m, y] = parts;
  if (y.length === 2) y = '20' + y;
  return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV
function processCSV(text) {
  dataBlocks = {
    SOT: { labels: [], data: {} },
    PMK: { labels: [], data: {} },
    TORUDA: { labels: [], data: {} }
  };
  const lines = text.trim().split(/\r?\n/);
  const pmkIdx = lines.findIndex(l => l.includes("PMK"));
  const torIdx = lines.findIndex(l => l.includes("TORUDA"));

  const SOTLines = lines.slice(0, pmkIdx);
  const PMKLines = lines.slice(pmkIdx, torIdx);
  const TORUDALines = lines.slice(torIdx);

  ['SOT', 'PMK', 'TORUDA'].forEach(block => {
    let blockLines;
    if (block === 'SOT') blockLines = SOTLines;
    else if (block === 'PMK') blockLines = PMKLines;
    else blockLines = TORUDALines;

    const parsedData = {};
    const dateSet = new Set();

    for (const line of blockLines) {
      const cols = line.split(';').map(c => c.trim());
      if (cols.length < 7) continue;
      const [person, tool, , , , , dateStr] = cols;
      const dateLabel = parseDate(dateStr);
      if (!dateLabel) continue;
      dateSet.add(dateLabel);
      const values = [];
      for (let i = 2; i <= 5; i++) {
        const v = parseFloat(cols[i].replace(',', '.')) || 0;
        values.push(v);
      }
      const total = values.reduce((a, b) => a + b, 0);
      if (!parsedData[tool]) parsedData[tool] = {};
      if (!parsedData[tool][person]) parsedData[tool][person] = {};
      if (!parsedData[tool][person][dateLabel]) parsedData[tool][person][dateLabel] = 0;
      parsedData[tool][person][dateLabel] += total;
    }
    const labelsArr = Array.from(dateSet).sort((a, b) => new Date(a) - new Date(b));
    const dataPerTool = {};
    for (const t in parsedData) {
      dataPerTool[t] = {};
      for (const p in parsedData[t]) {
        dataPerTool[t][p] = Array(labelsArr.length).fill(0);
        labelsArr.forEach((d, i) => {
          if (parsedData[t][p][d] !== undefined) {
            dataPerTool[t][p][i] = parsedData[t][p][d];
          }
        });
      }
    }
    dataBlocks[block].labels = labelsArr;
    dataBlocks[block].data = dataPerTool;
  });
  updateBlockOptions();
  const firstBlock = Object.keys(dataBlocks)[0];
  if (firstBlock) {
    selectBlock(firstBlock);
    toggleEmployeeSelection();
    updateChart();
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
function updateBlockOptions() {
  const select = document.getElementById('blockSelect');
  select.innerHTML = '';
  for (const b in dataBlocks) {
    const option = document.createElement('option');
    option.value = b;
    option.textContent = b;
    select.appendChild(option);
  }
  select.onchange = () => {
    selectBlock(select.value);
    toggleEmployeeSelection();
    updateChart();
  };
}

// –í—ã–±–æ—Ä –±–ª–æ–∫–∞
function selectBlock(name) {
  currentBlock = name;
  const blockData = dataBlocks[name];
  const tools = Object.keys(blockData.data);
  const selectTool = document.getElementById('toolSelect');
  const selectEmp = document.getElementById('employeeSelect');

  selectTool.innerHTML = '';
  selectEmp.innerHTML = '';

  tools.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    selectTool.appendChild(opt);
  });

  // —Å–æ–±–∏—Ä–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
  const employees = new Set();
  tools.forEach(t => {
    Object.keys(blockData.data[t] || {}).forEach(e => employees.add(e));
  });
  const empArr = Array.from(employees).sort();

  empArr.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e;
    opt.textContent = e;
    selectEmp.appendChild(opt);
  });

  document.getElementById('modeSelect').onchange = toggleEmployeeSelection;
  document.getElementById('toolSelect').onchange = () => {
    currentTool = document.getElementById('toolSelect').value;
    updateChart();
  };
  document.getElementById('employeeSelect').onchange = () => {
    currentEmployee = document.getElementById('employeeSelect').value;
    updateChart();
  };

  document.getElementById('modeSelect').value = 'all';
  toggleEmployeeSelection();

  if (tools.length > 0) {
    currentTool = tools[0];
    currentEmployee = empArr[0];
    document.getElementById('toolSelect').value = currentTool;
    document.getElementById('employeeSelect').value = currentEmployee;
    updateChart();
    document.getElementById('chartTitle').innerHTML = '<i class="fas fa-layer-group"></i> ' + name + ' | ' + currentTool;
  } else {
    if (chartInstance) chartInstance.destroy();
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
function toggleEmployeeSelection() {
  const mode = document.getElementById('modeSelect').value;
  document.getElementById('employeeBox').style.display = (mode === 'individual') ? 'flex' : 'none';
  updateChart();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞
function getChartTextColor() {
  return darkMode ? '#fff' : '#000';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart() {
  if (chartInstance) chartInstance.destroy();

  const ctx = document.getElementById('myChart').getContext('2d');
  const mode = document.getElementById('modeSelect').value;
  const tool = document.getElementById('toolSelect').value;
  const employee = document.getElementById('employeeSelect').value;
  const blockData = dataBlocks[currentBlock];
  if (!blockData) return;
  const labels = blockData.labels;
  const textColor = getChartTextColor();

  currentLabels = labels;

  if (!blockData.data[tool]) {
    if (chartInstance) chartInstance.destroy();
    return;
  }

  if (mode === 'all') {
    const persons = Object.keys(blockData.data[tool] || {});
    currentDatasets = persons.map((p, i) => ({
      label: p,
      data: blockData.data[tool][p],
      borderColor: getColor(i),
      backgroundColor: getColor(i, 0.2),
      borderWidth: 2,
      tension: 0.4,
      fill: true,
      pointBackgroundColor: getColor(i),
      pointBorderColor: '#fff'
    }));
  } else {
    if (employee && blockData.data[tool][employee]) {
      currentDatasets = [{
        label: employee,
        data: blockData.data[tool][employee],
        borderColor: getColor(0),
        backgroundColor: getColor(0, 0.2),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: getColor(0),
        pointBorderColor: '#fff'
      }];
    } else {
      currentDatasets = [];
    }
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: currentDatasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: textColor,
            font: { size: 14, weight: '600' },
            boxWidth: 20,
            boxHeight: 20,
            padding: 15,
            useBorderRadius: true,
            borderRadius: 4
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#ccc',
          borderWidth: 1,
          padding: 10,
          caretSize: 8,
          cornerRadius: 4
        }
      },
      scales: {
        x: {
          ticks: {
            color: textColor,
            font: { size: 14, weight: '600' }
          },
          grid: {
            color: getGridColor(),
            drawBorder: false,
            tickBorderColor: 'transparent'
          },
          title: {
            display: true,
            text: 'üìÖ –î–∞—Ç—ã',
            color: textColor,
            font: { size: 14, weight: '600' }
          }
        },
        y: {
          ticks: {
            color: textColor,
            font: { size: 14, weight: '600' },
            beginAtZero: true
          },
          grid: {
            color: getGridColor(),
            drawBorder: false
          },
          title: {
            display: true,
            text: '–ó–Ω–∞—á–µ–Ω–∏–µ',
            color: textColor,
            font: { size: 14, weight: '600' }
          }
        }
      },
      layout: {
        padding: {
          top: 20,
          bottom: 20,
          left: 20,
          right: 20
        }
      }
    }
  });
}

function getColor(idx, alpha=1) {
  const palette = [
    `rgba(255, 99, 132, ${alpha})`,
    `rgba(54, 162, 235, ${alpha})`,
    `rgba(255, 206, 86, ${alpha})`,
    `rgba(75, 192, 192, ${alpha})`,
    `rgba(153, 102, 255, ${alpha})`,
    `rgba(255, 159, 64, ${alpha})`,
    `rgba(199, 199, 199, ${alpha})`,
    `rgba(255, 99, 255, ${alpha})`,
    `rgba(0, 191, 255, ${alpha})`,
    `rgba(255, 215, 0, ${alpha})`
  ];
  return palette[idx % palette.length];
}

function getGridColor() {
  return getComputedStyle(document.body).getPropertyValue('--chart-text-color').trim();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
document.getElementById('refreshBtn').addEventListener('click', () => { updateChart(); });
document.getElementById('topBtn').addEventListener('click', showTopEmployees);
document.getElementById('exportSOTBtn').onclick = () => {
  document.getElementById('sotModal').classList.add('show');
};
document.getElementById('closeSOTModal').onclick = () => {
  document.getElementById('sotModal').classList.remove('show');
};
document.getElementById('sotModal').onclick = e => {
  if (e.target === document.getElementById('sotModal')) {
    document.getElementById('sotModal').classList.remove('show');
  }
};

// –¢–û–ü —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
function showTopEmployees() {
  if (!dataBlocks[currentBlock]) return;
  const blockData = dataBlocks[currentBlock];
  const tool = document.getElementById('toolSelect').value;
  const mode = document.getElementById('modeSelect').value;

  const sums = {};
  for (const emp in blockData.data[tool]) {
    sums[emp] = blockData.data[tool][emp].reduce((a, b) => a + b, 0);
  }

  const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);
  const top3 = sorted.slice(0, 3);
  const icons = ['ü•á','ü•à','ü•â'];
  let html = `<h3>üèÜ –¢–û–ü —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É: ${tool}</h3><ol style="list-style:none; padding-left:0;">`;
  top3.forEach((item, i) => {
    html += `<li style="margin:8px 0; font-size:1.4em;">${icons[i]} <strong>${item[0]}</strong> ‚Äî ${item[1].toFixed(2)}</li>`;
  });
  html += '</ol>';
  document.getElementById('averageResult').innerHTML = html;
}

const sheetUrl = 'https://docs.google.com/spreadsheets/d/11i0Nwwbw09aJQFNkztrAUfx0G8PXzUfg1sZyjeIKjxQ/gviz/tq?sheet=–õ–∏—Å—Ç2';

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å loadChangelogFromSheet
function loadChangelogFromSheet() {
  fetch(sheetUrl)
    .then(response => response.text())
    .then(text => {
      const jsonData = JSON.parse(text.substring(47).slice(0, -2));
      const rows = jsonData.table.rows;
      let entriesHtml = '';

      function formatDateToDDMMYY(dateStr) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ Date(...)
  const dateMatch = /Date\((\d+),\s*(\d+),\s*(\d+)\)/.exec(dateStr);
  if (dateMatch) {
    let year = parseInt(dateMatch[1], 10);
    let month = parseInt(dateMatch[2], 10); // –Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 0
    let day = parseInt(dateMatch[3], 10);

    // –ú–µ—Å—è—Ü +1, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—Å—è—Ü
    month += 1;

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    const dd = day.toString().padStart(2, '0');
    const mm = month.toString().padStart(2, '0');
    const yy = (year % 100).toString().padStart(2, '0');

    return `${dd}.${mm}.${yy}`;
  }
  // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é
  return dateStr;
}

      rows.forEach(row => {
        const version = row.c[0].v;
        const rawDate = row.c[1].v; // –∏—Å—Ö–æ–¥–Ω–∞—è –¥–∞—Ç–∞
        const date = formatDateToDDMMYY(rawDate); // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –¥–¥.–º–º.–≥–≥
        console.log('–ò—Å—Ö–æ–¥–Ω–∞—è –¥–∞—Ç–∞:', rawDate, '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è:', date); // –¥–æ–±–∞–≤—å—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const type = row.c[2].v.trim();
        let description = row.c[3].v;

        // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è
        description = description.replace(/^‚Ä¢\s?/gm, '<li>‚Ä¢</li>');

        const descriptionHtml = description
          .split('\n')
          .map(line => line.trim().startsWith('‚Ä¢') ? `<li>${line.trim()}</li>` : `<p>${line.trim()}</p>`)
          .join('');

        entriesHtml += `
          <div class="changelog-entry">
            <div class="changelog-header">
              <div>
                <span class="changelog-version">–í–µ—Ä—Å–∏—è ${version}</span>
                <span class="changelog-date">[${date}]</span>
              </div>
              <div class="changelog-type ${type}">${type}</div>
            </div>
            <ul style="margin:0; padding-left:20px;">${descriptionHtml}</ul>
          </div>`;
      });

      const container = document.getElementById('changelogContainer');
      container.innerHTML = '<h4 style="margin-top:0;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h4>' + entriesHtml;
    })
    .catch(() => {
      document.getElementById('changelogContainer').innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π.';
    });
}

// –í–∞—Ä–∏–∞–Ω—Ç 1: –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
window.addEventListener('load', () => {
  loadChangelogFromSheet();
  // —Ç–∞–∫–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑ localStorage
  const savedChangelog = localStorage.getItem('changelog') || '';
  document.getElementById('changelogText').value = savedChangelog;
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Changelog"
const changelogBtn = document.getElementById('changelogToggle');
const changelogContainer = document.getElementById('changelogContainer');

changelogBtn.addEventListener('click', () => {
  if (changelogContainer.classList.contains('show')) {
    changelogContainer.classList.remove('show');
  } else {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏, –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º
    loadChangelogFromSheet();
    changelogContainer.classList.add('show');
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
  const savedChangelog = localStorage.getItem('changelog') || '';
  document.getElementById('changelogText').value = savedChangelog;
});
</script>

</body>
</html>
