<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- –°—Ç–∏–ª—å -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

/* –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π –∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
:root {
  --font-family: 'Inter', sans-serif;
  --border-radius: 15px;
  --shadow: rgba(0, 0, 0, 0.05);
  --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
  --accent-gradient: linear-gradient(135deg, #89f7fe, #66a6ff);
  --background-gradient: linear-gradient(135deg, #f0f2f5, #d9e2ef);
  --text-color: #222;
  --bg-color: #fff;
  --border-color: #ccc;
  --hover-bg-color: #f4f4f4;
  --label-color: #333;
  --chart-bg-color: #fafafa;
  --button-bg: linear-gradient(135deg, #667eea, #764ba2);
  --button-hover-bg: linear-gradient(135deg, #5a9, #4a8);
  --result-bg: linear-gradient(135deg, #e0f7fa, #b2ebf2);
  --chart-text-color: #222; /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
body.dark {
  --text-color: #eee;
  --bg-color: #2b2b2b;
  --border-color: #555;
  --hover-bg-color: #444;
  --label-color: #ddd;
  --chart-bg-color: #3a3a3a;
  --button-bg: linear-gradient(135deg, #444, #222);
  --result-bg: linear-gradient(135deg, #555, #333);
  --chart-text-color: #eee; /* –¢–µ–∫—Å—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ */
}

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
body {
  margin: 0;
  font-family: var(--font-family);
  background: var(--background-gradient);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}

/* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã —Ç–µ–º—ã ‚Äî –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤—ã–π */
.theme-switch {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  padding: 10px 20px;
  border-radius: calc(var(--border-radius) / 2);
  cursor: pointer;
  font-size: 1em;
  font-weight: 600;
  color: #fff;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transition: background 0.3s, box-shadow 0.3s;
}
.theme-switch:hover {
  background: linear-gradient(135deg, #5a9, #4a8);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.container {
  flex: 0;
  max-width: 1400px;
  margin: 0 auto 50px;
  padding: 30px;
  background: var(--bg-color);
  border-radius: calc(var(--border-radius) * 2);
  box-shadow: 0 20px 50px var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 50px;
  overflow: hidden;
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
.top-panel {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ */
.file-zone {
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
}
.file-label {
  background: var(--primary-gradient);
  color: #fff;
  padding: 14px 24px;
  border-radius: calc(var(--border-radius) * 2);
  cursor: pointer;
  font-size: 1.4em;
  font-weight: 600;
  box-shadow: 0 8px 20px var(--shadow);
  transition: all 0.3s ease;
}
.file-label:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 25px var(--shadow);
}
#csvFileInput {
  display: none;
}
#exportSOTBtn {
  margin-left: 20px;
  padding: 14px 20px;
  font-size: 1.3em;
  border: none;
  border-radius: calc(var(--border-radius) * 2);
  background: var(--primary-gradient);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 12px var(--shadow);
  transition: all 0.3s ease;
}
#exportSOTBtn:hover {
 transform: translateY(-2px);
  box-shadow: 0 12px 25px var(--shadow);
}
 /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" */
  .back-btn {
    display: inline-block;
    padding: 14px 20px;
    font-size: 1.2em;
    font-weight: 600;
    color: #fff;
    background-color: #ff5722; /* —è—Ä–∫–∏–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: background-color 0.3s, transform 0.2s;
  }
  .back-btn:hover {
    background-color: #e64a19; /* —á—É—Ç—å —Ç–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    transform: translateY(-2px);
  }
/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
.settings {
  display: flex;
  flex-wrap: wrap;
  gap: 40px;
  flex: 2 1 700px;
  justify-content: center;
}
.setting-box {
  background: var(--hover-bg-color);
  padding: 20px 25px;
  border-radius: calc(var(--border-radius) * 2);
  box-shadow: 0 6px 15px var(--shadow);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 200px;
  transition: all 0.3s ease;
}
.setting-box:hover {
  box-shadow: 0 10px 20px var(--shadow);
}
.setting-box label {
  font-weight: 600;
  margin-bottom: 12px;
  font-size: 1.3em;
  color: var(--label-color);
}
.setting-box select {
  padding: 14px 20px;
  border-radius: calc(var(--border-radius) * 2);
  border: none;
  background: #fff;
  font-size: 1.3em;
  min-width: 150px;
  box-shadow: 0 4px 12px var(--shadow);
  cursor: pointer;
  transition: all 0.2s ease;
}
.setting-box select:hover {
  box-shadow: 0 6px 18px var(--shadow);
}

/* –ì—Ä–∞—Ñ–∏–∫ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã */
.chart-section {
  display: flex;
  flex-direction: column;
  align-items: center;
}
#chartTitle {
  font-size: 2.5em;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--label-color);
  text-align: center;
}
#chartContainer {
  width: 100%;
  max-width: 1500px;
  background: var(--chart-bg-color);
  padding: 40px;
  border-radius: calc(var(--border-radius) * 2);
  box-shadow: inset 0 10px 20px rgba(0,0,0,0.02);
  margin-bottom: 30px;
  transition: background 0.3s;
}

.btn {
  background: var(--primary-gradient);
  color: #fff;
  padding: 16px 35px;
  font-size: 1.4em;
  border: none;
  border-radius: calc(var(--border-radius) * 2);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: all 0.3s ease;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}
.btn:active {
  transform: translateY(0);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

/* –ò—Ç–æ–≥–æ–≤–∞—è –∑–æ–Ω–∞ */
#averageResult {
  margin-top: 40px;
  padding: 30px;
  background: var(--result-bg);
  border-radius: calc(var(--border-radius) * 2);
  font-size: 1.8em;
  font-weight: 600;
  color: var(--label-color);
  text-align: center;
  max-width: 800px;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  transition: background 0.3s, color 0.3s;
}
#averageResult:hover {
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∞–π—Ç–∞ (iframe) */
#sotModal {
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.5);
  justify-content: center; 
  align-items: center; 
  z-index: 9999;
}
#sotModal > div {
  background: #fff; 
  padding: 20px; 
  border-radius: 10px; 
  max-width: 90%; 
  width: 80%; 
  display: flex; 
  flex-direction: column; 
  align-items: stretch;
}
#sotIframe {
  width: 100%; 
  height: 70vh; 
  border: none; 
  border-radius: 10px;
}
#closeSOTModal {
  margin-top: 10px;
  padding: 10px 20px;
  font-size: 1.2em;
  border: none;
  border-radius: calc(var(--border-radius) * 2);
  background: #555;
  color: #fff;
  cursor: pointer;
  align-self: center;
}
#closeSOTModal:hover {
  background: #333;
}
</style>
</head>
<body>
<div style="margin-bottom:20px;">
  <button class="back-btn" onclick="window.open('index.html', '_self')">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
<button class="theme-switch" id="themeToggle">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>

<div class="container">

  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="top-panel">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="file-zone">
            <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <label class="file-label" id="exportSOTBtn">–í—ã–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª-–≤–æ –°–û–¢</label>
      <label class="file-label" for="csvFileInput">
        üìÅ –í—ã–±–µ—Ä–∏—Ç–µ CSV
      </label>
      <input type="file" id="csvFileInput" accept=".csv" />

    </div>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="settings">
      <div class="setting-box">
        <label for="blockSelect">–ë–ª–æ–∫</label>
        <select id="blockSelect"></select>
      </div>
      <div class="setting-box">
        <label for="toolSelect">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
        <select id="toolSelect"></select>
      </div>
      <div class="setting-box">
        <label for="modeSelect">–†–µ–∂–∏–º</label>
        <select id="modeSelect">
          <option value="all">–û–±—â–∏–π</option>
          <option value="individual">–ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</option>
        </select>
      </div>
      <div class="setting-box" id="employeeBox" style="display:none;">
        <label for="employeeSelect">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select id="employeeSelect"></select>
      </div>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫ –∏ –∏—Ç–æ–≥ -->
  <div class="chart-section">
    <div id="chartTitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
    <div id="chartContainer">
      <canvas id="myChart"></canvas>
    </div>
    <div class="buttons">
      <button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn" id="topBtn">–¢–û–ü</button>
    </div>
    <div id="averageResult"></div>
  </div>

</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∞–π—Ç–∞ -->
<div id="sotModal">
  <div>
    <h3>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É</h3>
    <iframe id="sotIframe" src="https://s-o-t.ru/netcat/?catalogue=1&sub=1891833"></iframe>
    <button class="btn" id="closeSOTModal">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
let dataBlocks = {
    SOT: { labels: [], data: {} },
    PMK: { labels: [], data: {} },
    TORUDA: { labels: [], data: {} }
};
let currentBlock = null;
let currentTool = null;
let currentEmployee = null;
let chartInstance = null;
let currentLabels = [];
let currentDatasets = [];

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
const themeBtn = document.getElementById('themeToggle');
let darkMode = false;
themeBtn.onclick = () => {
  darkMode = !darkMode;
  document.body.classList.toggle('dark');
  themeBtn.textContent = darkMode ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
  updateChart(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –≥—Ä–∞—Ñ–∏–∫–∞
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
document.getElementById('csvFileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        processCSV(e.target.result);
        document.getElementById('chartTitle').textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.';
        document.getElementById('averageResult').innerHTML = '';
        document.getElementById('modeSelect').value = 'all';
        toggleEmployeeSelection();
        updateChart();
    };
    reader.readAsText(file);
});

// –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
function parseDate(dateStr) {
    const parts = dateStr.trim().split('.');
    if (parts.length !== 3) return null;
    let day = parts[0], month = parts[1], year = parts[2];
    if (year.length === 2) year = '20' + year;
    return `${year.padStart(4, '0')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV
function processCSV(csvText) {
    dataBlocks = {
        SOT: { labels: [], data: {} },
        PMK: { labels: [], data: {} },
        TORUDA: { labels: [], data: {} }
    };
    const lines = csvText.trim().split(/\r?\n/);
    let pmkIdx = lines.findIndex(line => line.includes("PMK"));
    let torIdx = lines.findIndex(line => line.includes("TORUDA"));

    const SOTLines = lines.slice(0, pmkIdx);
    const PMKLines = lines.slice(pmkIdx, torIdx);
    const TORUDALines = lines.slice(torIdx);

    ['SOT', 'PMK', 'TORUDA'].forEach(block => {
        let blockLines = [];
        if (block === 'SOT') blockLines = SOTLines;
        else if (block === 'PMK') blockLines = PMKLines;
        else if (block === 'TORUDA') blockLines = TORUDALines;

        const parsedData = {};
        const datesSet = new Set();

        // –ø–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏
        blockLines.forEach(line => {
            const cols = line.split(';').map(c => c.trim());
            if (cols.length < 7) return;
            const person = cols[0];
            const tool = cols[1];
            const dateStr = cols[6];
            const dateLabel = parseDate(dateStr);
            if (!dateLabel) return;
            datesSet.add(dateLabel);

            const values = [];
            for (let i=2; i<=5; i++) {
                const v = parseFloat(cols[i].replace(',', '.')) || 0;
                values.push(v);
            }
            const totalValue = values.reduce((a,b)=>a+b,0);

            if (!parsedData[tool]) parsedData[tool] = {};
            if (!parsedData[tool][person]) parsedData[tool][person] = {};
            if (!parsedData[tool][person][dateLabel]) parsedData[tool][person][dateLabel] = 0;
            parsedData[tool][person][dateLabel] += totalValue;
        });

        const labelsArray = Array.from(datesSet).sort((a,b)=> new Date(a) - new Date(b));
        const dataPerTool = {};
        for (const tool in parsedData) {
            dataPerTool[tool] = {};
            for (const person in parsedData[tool]) {
                dataPerTool[tool][person] = Array(labelsArray.length).fill(0);
                labelsArray.forEach((date, idx) => {
                    if (parsedData[tool][person][date] !== undefined) {
                        dataPerTool[tool][person][idx] = parsedData[tool][person][date];
                    }
                });
            }
        }
        dataBlocks[block].labels = labelsArray;
        dataBlocks[block].data = dataPerTool;
    });
    updateBlockOptions();
    const firstBlock = Object.keys(dataBlocks)[0];
    if (firstBlock) {
        selectBlock(firstBlock);
        toggleEmployeeSelection();
        updateChart();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
function updateBlockOptions() {
    const select = document.getElementById('blockSelect');
    select.innerHTML = '';
    for (const block in dataBlocks) {
        const option = document.createElement('option');
        option.value = block;
        option.textContent = block;
        select.appendChild(option);
    }
    select.onchange = () => {
        selectBlock(select.value);
        toggleEmployeeSelection();
        updateChart();
    };
}

// –í—ã–±–æ—Ä –±–ª–æ–∫–∞
function selectBlock(blockName) {
    currentBlock = blockName;
    const blockData = dataBlocks[blockName];
    const tools = Object.keys(blockData.data);
    const selectTool = document.getElementById('toolSelect');
    const selectEmployee = document.getElementById('employeeSelect');

    selectTool.innerHTML = '';
    selectEmployee.innerHTML = '';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    tools.forEach(tool => {
        const option = document.createElement('option');
        option.value = tool;
        option.textContent = tool;
        selectTool.appendChild(option);
    });

    // –°–æ–±–∏—Ä–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    const employeesSet = new Set();
    tools.forEach(tool => {
        Object.keys(blockData.data[tool]).forEach(emp => employeesSet.add(emp));
    });
    const employeesArr = Array.from(employeesSet).sort();

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    employeesArr.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp;
        option.textContent = emp;
        selectEmployee.appendChild(option);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('modeSelect').onchange = toggleEmployeeSelection;
    document.getElementById('toolSelect').onchange = () => {
      currentTool = document.getElementById('toolSelect').value;
      updateChart();
    };
    document.getElementById('employeeSelect').onchange = () => {
      currentEmployee = document.getElementById('employeeSelect').value;
      updateChart();
    };

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º "–û–±—â–∏–π" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('modeSelect').value = 'all';
    toggleEmployeeSelection();

    // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    if (tools.length > 0) {
        currentTool = tools[0];
        currentEmployee = employeesArr[0];
        document.getElementById('toolSelect').value = currentTool;
        document.getElementById('employeeSelect').value = currentEmployee;
        updateChart();
        document.getElementById('chartTitle').textContent = `–ë–ª–æ–∫: ${currentBlock} | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${currentTool}`;
    } else {
        if (chartInstance) chartInstance.destroy();
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function toggleEmployeeSelection() {
  const mode = document.getElementById('modeSelect').value;
  const empBox = document.getElementById('employeeBox');
  if (mode === 'individual') {
    empBox.style.display = 'flex';
  } else {
    empBox.style.display = 'none';
  }
  updateChart();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
function getChartTextColor() {
  return darkMode ? '#fff' : '#000';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart() {
  if (chartInstance) {
    chartInstance.destroy();
  }

  const ctx = document.getElementById('myChart').getContext('2d');

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  const mode = document.getElementById('modeSelect').value;
  const selectedTool = document.getElementById('toolSelect').value;
  const selectedEmployee = document.getElementById('employeeSelect').value;

  const blockData = dataBlocks[currentBlock];
  if (!blockData) return;
  const labels = blockData.labels;

  const textColor = getChartTextColor();

  currentLabels = labels;

  if (!blockData.data[selectedTool]) {
    if (chartInstance) chartInstance.destroy();
    return;
  }

  if (mode === 'all') {
    const persons = Object.keys(blockData.data[selectedTool] || {});
    currentDatasets = persons.map((person, index) => ({
      label: person,
      data: blockData.data[selectedTool][person],
      borderColor: getColor(index),
      backgroundColor: getColor(index, 0.4),
      borderWidth: 2,
      tension: 0.3,
      fill: false,
      pointBackgroundColor: getColor(index),
      pointBorderColor: '#fff'
    }));
  } else {
    if (selectedEmployee && blockData.data[selectedTool][selectedEmployee]) {
      currentDatasets = [{
        label: selectedEmployee,
        data: blockData.data[selectedTool][selectedEmployee],
        borderColor: getColor(0),
        backgroundColor: getColor(0, 0.4),
        borderWidth: 3,
        tension: 0.3,
        fill: false,
        pointBackgroundColor: getColor(0),
        pointBorderColor: '#fff'
      }];
    } else {
      currentDatasets = [];
    }
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: currentLabels,
      datasets: currentDatasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: {
            color: textColor,
            font: { size: 14, weight: '600' }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.7)',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      },
      scales: {
        x: {
          ticks: { color: textColor },
          title: { display: true, text: '–î–∞—Ç—ã', color: textColor },
          grid: { color: getGridColor() }
        },
        y: {
          ticks: { color: textColor },
          title: { display: true, text: '–ó–Ω–∞—á–µ–Ω–∏–µ', color: textColor },
          grid: { color: getGridColor() }
        }
      }
    }
  });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ª–∏–Ω–∏–π
function getColor(index, alpha=1) {
  const palette = [
    `rgba(255, 99, 132, ${alpha})`,
    `rgba(54, 162, 235, ${alpha})`,
    `rgba(255, 206, 86, ${alpha})`,
    `rgba(75, 192, 192, ${alpha})`,
    `rgba(153, 102, 255, ${alpha})`,
    `rgba(255, 159, 64, ${alpha})`,
    `rgba(199, 199, 199, ${alpha})`,
    `rgba(255, 99, 255, ${alpha})`,
    `rgba(0, 191, 255, ${alpha})`,
    `rgba(255, 215, 0, ${alpha})`
  ];
  return palette[index % palette.length];
}

// –¶–≤–µ—Ç –ª–∏–Ω–∏–π —Å–µ—Ç–∫–∏
function getGridColor() {
  return getComputedStyle(document.body).getPropertyValue('--chart-text-color').trim();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
document.getElementById('refreshBtn').addEventListener('click', () => {
  updateChart();
});
document.getElementById('topBtn').addEventListener('click', showTopEmployees);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í—ã–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª-–≤–æ –°–û–¢"
document.getElementById('exportSOTBtn').onclick = () => {
  document.getElementById('sotModal').style.display = 'flex';
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('closeSOTModal').onclick = () => {
  document.getElementById('sotModal').style.display = 'none';
};
// –ö–ª–∏–∫ –≤–Ω–µ –æ–∫–Ω–∞
document.getElementById('sotModal').onclick = (e) => {
  if (e.target === document.getElementById('sotModal')) {
    document.getElementById('sotModal').style.display = 'none';
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –¢–û–ü —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
function showTopEmployees() {
  if (!dataBlocks[currentBlock]) return;
  const blockData = dataBlocks[currentBlock];
  const currentToolSelected = document.getElementById('toolSelect').value;
  const mode = document.getElementById('modeSelect').value;

  const employeeSums = {};
  for (const employee in blockData.data[currentToolSelected]) {
    employeeSums[employee] = blockData.data[currentToolSelected][employee].reduce((a, b) => a + b, 0);
  }

  const sortedEmployees = Object.entries(employeeSums)
    .sort((a, b) => b[1] - a[1]);

  const top3 = sortedEmployees.slice(0, 3);
  const icons = ['ü•á','ü•à','ü•â'];
  let html = `<h3>–¢–û–ü —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É: ${currentToolSelected}</h3><ol style="list-style:none; padding-left:0;">`;
  top3.forEach((item, index) => {
    html += `<li style="margin:8px 0; font-size:1.4em;">${icons[index]} <strong>${item[0]}</strong> ‚Äî ${item[1].toFixed(2)}</li>`;
  });
  html += '</ol>';

  document.getElementById('averageResult').innerHTML = html;
}
</script>

</body>
</html>